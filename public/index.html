<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Tech Platform - Feed</title>
    <style>
        :root { --primary: #0071e3; --bg: #f5f5f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —à–∞–ø–∫–∏ */
        .navbar { background: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 20px; font-weight: bold; color: var(--primary); text-decoration: none; }
        .user-menu { display: flex; align-items: center; gap: 20px; }
        .welcome-text { font-weight: 500; color: #333; }
        .btn-logout { background: #ff3b30; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; }
        .btn-login { background: var(--primary); color: white; text-decoration: none; padding: 8px 15px; border-radius: 6px; }

        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .card { background: white; border-radius: 18px; padding: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .type-tag { font-size: 11px; font-weight: bold; text-transform: uppercase; color: var(--primary); }
        .like-btn {
            background: #fff;
            border: 1px solid #ff3b30;
            color: #ff3b30;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        .like-btn:hover {
            background: #fff5f5;
        }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="/" class="logo">TechPlatform</a>
    <div id="auth-section" class="user-menu">
    </div>
</nav>

<div class="container">
    <h1 id="page-title">–ò–Ω–Ω–æ–≤–∞—Ü–∏–∏ –≤ IT üöÄ</h1>
    <div id="feed" class="grid"></div>
</div>

<script>
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —à–∞–ø–∫–∏ (–≤—ã–Ω–µ—Å–µ–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
    function renderUserHeader(user) {
        const authSection = document.getElementById('auth-section');
        if (!authSection) return;

        authSection.innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="/profile.html" style="text-decoration: none; color: inherit; font-weight: 500;">
                –ü—Ä–∏–≤–µ—Ç, üëã ${user.username}!
            </a>
            <button onclick="logout()" style="background: none; border: 1px solid #ff3b30; color: #ff3b30; padding: 5px 10px; border-radius: 5px; cursor: pointer;">–í—ã–π—Ç–∏</button>
        </div>
    `;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å —Ñ–æ–Ω–æ–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
    async function checkAuth() {
        const userData = localStorage.getItem('user');
        if (!userData) {
            window.location.href = '/login.html';
            return;
        }

        let user = JSON.parse(userData);

        // 1. –°—Ä–∞–∑—É —Ä–∏—Å—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage (—á—Ç–æ–±—ã —é–∑–µ—Ä –Ω–µ –∂–¥–∞–ª)
        renderUserHeader(user);

        // 2. –í –§–û–ù–ï –∏–¥–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∑–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        try {
            const userId = user.id || user._id;
            const response = await fetch(`/api/users/${userId}`);

            if (response.ok) {
                const freshUser = await response.json();

                // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º: –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç —Ç–µ—Ö, —á—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                if (JSON.stringify(freshUser.interests) !== JSON.stringify(user.interests) ||
                    freshUser.username !== user.username) {

                    console.log("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ MongoDB");

                    // –û–±–Ω–æ–≤–ª—è–µ–º localStorage –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π
                    const updatedData = { ...freshUser, id: freshUser._id };
                    localStorage.setItem('user', JSON.stringify(updatedData));

                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —à–∞–ø–∫—É —Å–≤–µ–∂–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                    renderUserHeader(updatedData);
                }
            }
        } catch (err) {
            console.warn("–§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç —Å–µ—Ç–∏)");
        }
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.reload();
    }

    // 2. –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–¢–ï–ù–¢–ê (—Å –∫–Ω–æ–ø–∫–æ–π –ª–∞–π–∫–∞)
    async function fetchFeed() {
        const response = await fetch('/api/content');
        const data = await response.json();
        const feedElement = document.getElementById('feed');

        feedElement.innerHTML = data.map(item => `
            <div class="card">
                <div class="type-tag">${item.type === 'video' ? 'üé• –í–∏–¥–µ–æ' : 'üìÑ –°—Ç–∞—Ç—å—è'}</div>
                <h3>${item.title}</h3>
                <p style="color: #666; font-size: 14px;">${item.preview}</p>
                <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 13px; color: #888;">
                        üë§ ${item.authorId?.username || '–ê–≤—Ç–æ—Ä'}
                    </div>
                    <button onclick="handleLike('${item._id}')" class="like-btn">
                        ‚ù§Ô∏è <span id="likes-count-${item._id}">${item.likes || 0}</span>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // 3. –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ö–ò –õ–ê–ô–ö–ê
    async function handleLike(contentId) {
        const storedUser = localStorage.getItem('user');
        if (!storedUser) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ!");
            return;
        }

        const user = JSON.parse(storedUser);
        const userId = user.id || user._id;

        const res = await fetch(`/api/content/${contentId}/like`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: userId })
        });

        if (res.ok) {
            const data = await res.json();

            const countSpan = document.getElementById(`likes-count-${contentId}`);
            countSpan.innerText = data.likes;

            const btn = countSpan.parentElement;
            btn.style.background = data.isLiked ? "#ff3b30" : "#fff";
            btn.style.color = data.isLiked ? "#fff" : "#ff3b30";
        }
    }

    checkAuth();
    fetchFeed();
</script>
</body>
</html>