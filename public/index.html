<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Platform - –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–∞—è –õ–µ–Ω—Ç–∞</title>
    <style>
        :root { --primary: #0071e3; --bg: #f5f5f7; --card-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; color: #1d1d1f; overflow-y: scroll; }

        .navbar { background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); padding: 12px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 0 rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 20px; font-weight: 700; color: var(--primary); text-decoration: none; letter-spacing: -0.5px; }
        .user-menu { display: flex; align-items: center; gap: 20px; }

        .notif-bell { position: relative; text-decoration: none; font-size: 20px; cursor: pointer; transition: 0.2s; }
        .notif-dot { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: #ff3b30; border-radius: 50%; border: 2px solid #fff; display: none; animation: pulse 2s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

        .feed-tabs { display: flex; gap: 25px; margin-bottom: 25px; border-bottom: 1px solid #d2d2d7; overflow-x: auto; padding-bottom: 5px; }
        .feed-tab { padding: 12px 0; background: none; border: none; font-size: 15px; font-weight: 600; color: #86868b; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; flex-shrink: 0; }
        .feed-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        .search-container { margin-bottom: 30px; position: relative; }
        .global-search { width: 100%; padding: 16px 25px; border-radius: 16px; border: 1px solid #d2d2d7; font-size: 16px; outline: none; transition: 0.3s; background: white; box-sizing: border-box; }
        .global-search:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(0,113,227,0.1); }

        .main-layout { display: grid; grid-template-columns: 1fr 300px; gap: 30px; }

        .post-stub { background: white; border-radius: 18px; padding: 16px 20px; display: flex; align-items: center; gap: 15px; margin-bottom: 25px; cursor: pointer; box-shadow: var(--card-shadow); border: 1px solid rgba(0,0,0,0.05); transition: 0.2s; }
        .post-stub:hover { background: #fafafa; border-color: var(--primary); }
        .post-stub-input { background: #f5f5f7; flex-grow: 1; padding: 12px 20px; border-radius: 25px; color: #86868b; font-size: 15px; font-weight: 500; }
        .mini-avatar-stub { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; }

        .category-bar { display: flex; gap: 8px; margin-bottom: 20px; align-items: center; overflow-x: auto; padding-bottom: 8px; }
        .cat-btn { padding: 8px 18px; border-radius: 20px; border: none; background: #e8e8ed; cursor: pointer; font-weight: 500; transition: 0.2s; white-space: nowrap; color: #1d1d1f; }
        .cat-btn.active { background: var(--primary); color: white; }

        .view-switcher { display: flex; background: #e8e8ed; padding: 4px; border-radius: 12px; gap: 4px; margin-left: auto; }
        .view-btn { border: none; background: none; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 16px; transition: 0.2s; display: flex; align-items: center; opacity: 0.6; }
        .view-btn.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); opacity: 1; }

        .grid { display: grid; gap: 25px; }
        .grid.view-grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }

        .card { background: white; border-radius: 18px; padding: 24px; box-shadow: var(--card-shadow); transition: 0.3s; position: relative; border: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; margin-bottom: 25px;}
        .card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }

        .type-tag { font-size: 11px; font-weight: 700; color: var(--primary); text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 0.5px; }

        .media-container { width: calc(100% + 48px); margin: 0 -24px 15px -24px; max-height: 400px; overflow: hidden; background: #000; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .media-container img { width: 100%; height: 100%; object-fit: cover; }
        .play-overlay { position: absolute; background: rgba(0,0,0,0.6); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid white; pointer-events: none; }

        .author-wrapper { position: relative; display: inline-block; }
        .hover-card { position: absolute; bottom: 120%; left: 0; width: 260px; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid #f0f0f2; display: none; z-index: 1000; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .author-wrapper:hover .hover-card { display: block; }

        .hc-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .hc-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .hc-stats { display: flex; justify-content: space-around; border-top: 1px solid #f5f5f7; padding-top: 12px; text-align: center; }
        .hc-stat-item { font-size: 12px; color: #86868b; }
        .hc-stat-item b { display: block; color: #1d1d1f; font-size: 14px; }
        .btn-hc-follow { width: 100%; margin-top: 12px; padding: 10px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-hc-follow.active { background: #e8e8ed; color: #1d1d1f; }

        .actions-bar { margin-top: auto; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f5f5f7; padding-top: 15px; }
        .action-btn { background: #f5f5f7; border: none; color: #1d1d1f; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px; font-size: 13px; transition: 0.2s; }
        .action-btn.active { background: #ff3b30; color: white; }

        .comments-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee; display: none; }
        .comment-item { display: flex; gap: 10px; margin-bottom: 12px; font-size: 13px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .comment-bubble { background: #f5f5f7; padding: 10px; border-radius: 12px; flex-grow: 1; }
        .comment-input-area { display: flex; gap: 8px; margin-top: 15px; }
        .comment-input { flex-grow: 1; padding: 8px 15px; border: 1px solid #d2d2d7; border-radius: 20px; outline: none; }
        .comment-send-btn { border: none; background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; }

        .sidebar-box { background: white; padding: 24px; border-radius: 18px; box-shadow: var(--card-shadow); position: sticky; top: 100px; }
        .interest-tag { display: inline-block; background: #f5f5f7; color: #515154; padding: 5px 12px; border-radius: 8px; font-size: 12px; margin: 8px 6px 0 0; cursor: pointer; transition: 0.2s; }

        @media (max-width: 900px) { .main-layout { grid-template-columns: 1fr; } .sidebar { display: none; } }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="/" class="logo">TechPlatform</a>
    <div id="auth-section" class="user-menu"></div>
</nav>

<div class="container">
    <div class="feed-tabs">
        <button class="feed-tab active" id="tab-all" onclick="setFeedType('all')">–î–ª—è –≤–∞—Å</button>
        <button class="feed-tab" id="tab-following" onclick="setFeedType('following')">–ü–æ–¥–ø–∏—Å–∫–∏ üë•</button>
        <button class="feed-tab" id="tab-my-posts" onclick="setFeedType('my-posts')">–ú–æ–∏ –ø–æ—Å—Ç—ã üìÑ</button>
        <button class="feed-tab" id="tab-liked" onclick="setFeedType('liked')">–õ–∞–π–∫–∏ ‚ù§Ô∏è</button>
    </div>

    <div class="search-container">
        <input type="text" id="global-search" class="global-search" oninput="handleSearch()" placeholder="üîç –ü–æ–∏—Å–∫ –∏–Ω–Ω–æ–≤–∞—Ü–∏–π...">
    </div>

    <div class="main-layout">
        <div class="content-area">
            <div class="post-stub" onclick="window.location.href='/create-post.html'">
                <div id="mini-avatar-placeholder"></div>
                <div class="post-stub-input">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∏–Ω–Ω–æ–≤–∞—Ü–∏–µ–π...</div>
            </div>

            <div class="category-bar">
                <button class="cat-btn active" id="cat-all" onclick="setCategory('All', this)">–í—Å–µ</button>
                <button class="cat-btn" onclick="setCategory('Programming', this)">Programming</button>
                <button class="cat-btn" onclick="setCategory('Gadgets', this)">Gadgets</button>
                <button class="cat-btn" onclick="setCategory('Design', this)">Design</button>

                <div class="view-switcher">
                    <button class="view-btn" id="btn-view-list" onclick="setView('list')">‚ò∞</button>
                    <button class="view-btn" id="btn-view-grid" onclick="setView('grid')">‚äû</button>
                </div>
            </div>

            <div id="feed" class="grid view-list"></div>
        </div>

        <aside class="sidebar">
            <div class="sidebar-box">
                <h3>–¢—Ä–µ–Ω–¥–æ–≤—ã–µ —Ç–µ–≥–∏ ‚ú®</h3>
                <div id="trending-tags"></div>
            </div>
        </aside>
    </div>
</div>

<script>
    let currentCategory = 'All';
    let currentFeedType = 'all';
    let allPosts = [];
    let currentView = localStorage.getItem('preferredView') || 'list';
    const currentUser = JSON.parse(localStorage.getItem('user'));

    function getYouTubeID(url) {
        if (!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    async function checkAuth() {
        if (!currentUser) { window.location.href = '/login.html'; return; }
        renderUserHeader(currentUser);
        setView(currentView);
        checkNewNotifications();
        setInterval(checkNewNotifications, 15000);
        fetchFeed();
    }

    function renderUserHeader(user) {
        const authSection = document.getElementById('auth-section');
        const miniAvatarPlace = document.getElementById('mini-avatar-placeholder');
        const avatarHtml = user.avatarUrl
            ? `<img src="${user.avatarUrl}" class="mini-avatar-stub">`
            : `<div class="mini-avatar-stub" style="background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-size:14px;">${user.username ? user.username[0] : 'U'}</div>`;

        if (miniAvatarPlace) miniAvatarPlace.innerHTML = avatarHtml;
        authSection.innerHTML = `
            <a href="/notifications.html" class="notif-bell">üîî<span class="notif-dot" id="notif-dot"></span></a>
            <a href="/profile.html" style="text-decoration:none; color:inherit; font-weight:600; display:flex; align-items:center; gap:8px;">
                ${avatarHtml} ${user.username}
            </a>
            <button onclick="logout()" style="background:none; border:1px solid #d2d2d7; padding:6px 12px; border-radius:8px; cursor:pointer; font-size:12px; margin-left:10px;">–í—ã—Ö–æ–¥</button>
        `;
    }

    async function checkNewNotifications() {
        try {
            const userId = currentUser._id || currentUser.id;
            const res = await fetch(`/api/notifications/${userId}`);
            const data = await res.json();
            const dot = document.getElementById('notif-dot');
            if (dot) {
                const hasUnread = data.some(n => n.read === false);
                dot.style.display = hasUnread ? 'block' : 'none';
            }
        } catch (e) { console.error("Notif Error:", e); }
    }

    function setFeedType(type) {
        currentFeedType = type;
        document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${type}`).classList.add('active');
        currentCategory = 'All';
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('cat-all').classList.add('active');
        fetchFeed();
    }

    function setView(view) {
        currentView = view;
        localStorage.setItem('preferredView', view);
        const feed = document.getElementById('feed');
        feed.className = `grid view-${view}`;
        document.getElementById('btn-view-list').classList.toggle('active', view === 'list');
        document.getElementById('btn-view-grid').classList.toggle('active', view === 'grid');
    }

    function setCategory(cat, btn) {
        currentCategory = cat;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        fetchFeed();
    }

    // –£–ú–ù–ê–Ø –õ–ï–ù–¢–ê: –µ—Å–ª–∏ "–î–ª—è –≤–∞—Å", –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä–µ—Å—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    async function fetchFeed() {
        const feedEl = document.getElementById('feed');
        feedEl.innerHTML = '<div style="text-align:center; padding:50px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–Ω–æ–≤–∞—Ü–∏–π...</div>';
        try {
            const userId = currentUser._id || currentUser.id;
            let url;

            if (currentFeedType === 'all') {
                // –ï—Å–ª–∏ —é–∑–µ—Ä –Ω–∞ –æ–±—â–µ–π –ª–µ–Ω—Ç–µ, —É—á–∏—Ç—ã–≤–∞–µ–º –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å—ã
                const interests = currentUser.interests && currentUser.interests.length > 0
                    ? currentUser.interests.join(',').toLowerCase()
                    : '';
                url = `/api/content?category=${currentCategory}&interests=${interests}`;
            } else {
                switch(currentFeedType) {
                    case 'following': url = `/api/content/following/${userId}`; break;
                    case 'my-posts': url = `/api/content/my-posts/${userId}`; break;
                    case 'liked': url = `/api/content/liked/${userId}`; break;
                }
            }

            const res = await fetch(url);
            allPosts = await res.json();
            renderPosts(allPosts);
            updateTrendingTags(allPosts);
        } catch (e) {
            console.error("Feed Error:", e);
            feedEl.innerHTML = "<div style='text-align:center; color:red;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.</div>";
        }
    }

    function renderPosts(data) {
        const feed = document.getElementById('feed');
        const userId = currentUser?._id || currentUser?.id;

        if (!data || !data.length) {
            feed.innerHTML = `<div style="text-align:center; padding:50px; color:#86868b;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
            return;
        }

        feed.innerHTML = data.map(item => {
            const ytId = getYouTubeID(item.mediaUrl) || getYouTubeID(item.body);
            const userHasLiked = item.likedBy?.map(id => id.toString()).includes(userId.toString());
            const author = item.authorId || {};
            const authorId = author._id || author;
            const isOwner = authorId.toString() === userId.toString();

            return `
            <div class="card" id="post-${item._id}">
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <span class="type-tag">${item.category || '–û–±—â–µ–µ'}</span>
                    ${isOwner ? `<button onclick="deletePost('${item._id}')" style="background:none; border:none; color:#ff3b30; cursor:pointer; font-size:12px;">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                </div>
                <h3 onclick="location.href='/post.html?id=${item._id}'" style="cursor:pointer;">${item.title}</h3>

                <div onclick="location.href='/post.html?id=${item._id}'" style="cursor:pointer">
                    ${item.mediaUrl && !ytId ? `<div class="media-container"><img src="${item.mediaUrl}"></div>` :
                (ytId ? `<div class="media-container"><img src="https://img.youtube.com/vi/${ytId}/maxresdefault.jpg"><div class="play-overlay">‚ñ∂</div></div>` :
                    `<p style="color:#555; line-height:1.5;">${item.preview || '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é...'}</p>`)}
                </div>

                <div class="actions-bar">
                    <div class="author-wrapper" onmouseenter="showMiniProfile('${authorId}', '${item._id}')">
                        <span style="font-size:13px; color:#86868b; cursor:pointer;">üë§ <b>${author.username || 'User'}</b></span>
                        <div id="hover-card-${item._id}" class="hover-card">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>

                    <div style="display:flex; gap:8px;">
                        <button onclick="handleLike('${item._id}')" class="action-btn ${userHasLiked ? 'active' : ''}" id="like-btn-${item._id}">
                            ‚ù§Ô∏è <span id="likes-count-${item._id}">${item.likes || 0}</span>
                        </button>
                        <button onclick="toggleComments('${item._id}')" class="action-btn">
                            üí¨ <span id="comm-count-${item._id}">${item.stats?.commentsCount || 0}</span>
                        </button>
                    </div>
                </div>

                <div id="comments-block-${item._id}" class="comments-section">
                    <div id="comments-list-${item._id}" style="max-height: 200px; overflow-y: auto;"></div>
                    <div class="comment-input-area">
                        <input type="text" id="input-${item._id}" class="comment-input" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
                        <button onclick="addCommentMain('${item._id}')" class="comment-send-btn">üöÄ</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    async function showMiniProfile(authorId, postId) {
        const card = document.getElementById(`hover-card-${postId}`);
        const me = currentUser._id || currentUser.id;
        if (!card || card.innerHTML !== '–ó–∞–≥—Ä—É–∑–∫–∞...') return;
        try {
            const [userRes, followRes] = await Promise.all([
                fetch(`/api/users/mini-profile/${authorId}`),
                fetch(`/api/follow/status?followerId=${me}&followingId=${authorId}`)
            ]);
            const user = await userRes.json();
            const follow = await followRes.json();
            card.innerHTML = `
                <div class="hc-header">
                    <img src="${user.avatarUrl || 'https://api.dicebear.com/7.x/big-ears/svg?seed='+user.username}" class="hc-avatar">
                    <div>
                        <div style="font-weight:700;">${user.username}</div>
                        <div style="font-size:11px; color:#86868b;">–ò–Ω–Ω–æ–≤–∞—Ç–æ—Ä</div>
                    </div>
                </div>
                <div class="hc-stats">
                    <div class="hc-stat-item"><b>${user.postsCount || 0}</b> –ø–æ—Å—Ç–æ–≤</div>
                    <div class="hc-stat-item"><b>${user.followersCount || 0}</b> –ø–æ–¥–ø.</div>
                </div>
                ${authorId.toString() !== me.toString() ? `<button onclick="handleFollowHC('${authorId}', '${postId}')" class="btn-hc-follow ${follow.following ? 'active' : ''}">${follow.following ? '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'}</button>` : ''}
            `;
        } catch (e) { card.innerHTML = "–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö"; }
    }

    async function handleFollowHC(targetId, postId) {
        const me = currentUser._id || currentUser.id;
        try {
            const res = await fetch('/api/follow', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ followerId: me, followingId: targetId })
            });
            if (res.ok) {
                const hcCard = document.getElementById(`hover-card-${postId}`);
                if (hcCard) { hcCard.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞..."; showMiniProfile(targetId, postId); }
            }
        } catch (e) { console.error(e); }
    }

    async function handleLike(id) {
        const btn = document.getElementById(`like-btn-${id}`);
        const span = document.getElementById(`likes-count-${id}`);
        const wasActive = btn.classList.contains('active');

        btn.classList.toggle('active');
        span.innerText = wasActive ? Math.max(0, parseInt(span.innerText) - 1) : parseInt(span.innerText) + 1;

        try {
            await fetch(`/api/content/${id}/like`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId: currentUser._id || currentUser.id })
            });
        } catch (e) { console.error("Like error:", e); }
    }

    function toggleComments(id) {
        const block = document.getElementById(`comments-block-${id}`);
        if (!block) return;
        const isHidden = block.style.display === 'none' || block.style.display === '';
        block.style.display = isHidden ? 'block' : 'none';
        if (isHidden) loadCommentsMain(id);
    }

    async function loadCommentsMain(postId) {
        const list = document.getElementById(`comments-list-${postId}`);
        try {
            const res = await fetch(`/api/comments/${postId}`);
            const comments = await res.json();
            list.innerHTML = comments.length ? comments.map(c => `
                <div class="comment-item">
                    <img src="${c.authorId?.avatarUrl || ''}" onerror="this.src='https://api.dicebear.com/7.x/big-ears/svg?seed=${c.authorId?.username || 'U'}'" style="width:24px; height:24px; border-radius:50%; object-fit:cover;">
                    <div class="comment-bubble">
                        <b style="font-size:12px;">${c.authorId?.username || 'User'}:</b> ${c.text}
                    </div>
                </div>`).join('') : '<div style="font-size:12px; color:#888; padding:10px 0;">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</div>';
            list.scrollTop = list.scrollHeight;
        } catch (e) { console.error(e); }
    }

    async function addCommentMain(postId) {
        const input = document.getElementById(`input-${postId}`);
        const text = input.value.trim();
        if (!text) return;
        try {
            const res = await fetch('/api/comments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ postId, userId: currentUser.id || currentUser._id, text })
            });
            if (res.ok) {
                input.value = '';
                await loadCommentsMain(postId);
                const countSpan = document.getElementById(`comm-count-${postId}`);
                if (countSpan) countSpan.innerText = parseInt(countSpan.innerText) + 1;
            }
        } catch (e) { console.error(e); }
    }

    function handleSearch() {
        const query = document.getElementById('global-search').value.toLowerCase();
        const filtered = allPosts.filter(p => p.title.toLowerCase().includes(query) || (p.tags && p.tags.some(t => t.toLowerCase().includes(query))));
        renderPosts(filtered);
    }

    function updateTrendingTags(posts) {
        const tagsMap = {};
        posts.forEach(p => { if(p.tags) p.tags.forEach(t => tagsMap[t] = (tagsMap[t] || 0) + 1); });
        const sorted = Object.keys(tagsMap).sort((a,b) => tagsMap[b] - tagsMap[a]).slice(0, 6);
        document.getElementById('trending-tags').innerHTML = sorted.map(t => `<span class="interest-tag" onclick="filterByTag('${t}')">#${t}</span>`).join('');
    }

    function filterByTag(tag) {
        document.getElementById('global-search').value = tag;
        handleSearch();
    }

    async function deletePost(id) {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç –Ω–∞–≤—Å–µ–≥–¥–∞?")) return;
        try {
            const res = await fetch(`/api/content/${id}`, { method: 'DELETE' });
            if(res.ok) fetchFeed();
        } catch (e) { console.error(e); }
    }

    function logout() { localStorage.clear(); window.location.href = '/login.html'; }

    checkAuth();
</script>
</body>
</html>