<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Platform - –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–∞—è –õ–µ–Ω—Ç–∞</title>
    <style>
        :root { --primary: #0071e3; --bg: #f5f5f7; --card-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; color: #1d1d1f; overflow-y: scroll; }

        .navbar { background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); padding: 12px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 0 rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 20px; font-weight: 700; color: var(--primary); text-decoration: none; letter-spacing: -0.5px; }
        .user-menu { display: flex; align-items: center; gap: 20px; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

        /* –ü–æ–∏—Å–∫ */
        .search-container { margin-bottom: 30px; position: relative; }
        .global-search {
            width: 100%; padding: 16px 25px; border-radius: 16px; border: 1px solid #d2d2d7;
            font-size: 16px; outline: none; transition: 0.3s; background: white; box-sizing: border-box;
        }
        .global-search:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(0,113,227,0.1); }

        /* –õ–µ–π–∞—É—Ç */
        .main-layout { display: grid; grid-template-columns: 1fr 300px; gap: 30px; }

        .category-bar { display: flex; gap: 8px; margin-bottom: 20px; align-items: center; overflow-x: auto; padding-bottom: 8px; }
        .cat-btn {
            padding: 8px 18px; border-radius: 20px; border: none;
            background: #e8e8ed; cursor: pointer; font-weight: 500; transition: 0.2s; white-space: nowrap; color: #1d1d1f;
        }
        .cat-btn.active { background: var(--primary); color: white; }

        /* –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –í–ò–î–ê */
        .view-switcher { display: flex; background: #e8e8ed; padding: 4px; border-radius: 12px; gap: 4px; margin-left: auto; }
        .view-btn { border: none; background: none; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 16px; transition: 0.2s; display: flex; align-items: center; opacity: 0.6; }
        .view-btn.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); opacity: 1; }

        .post-stub {
            background: white; border-radius: 16px; padding: 16px 20px; display: flex;
            align-items: center; gap: 12px; margin-bottom: 25px; cursor: pointer;
            box-shadow: var(--card-shadow); border: 1px solid rgba(0,0,0,0.05);
        }
        .post-stub-input { background: #f5f5f7; flex-grow: 1; padding: 10px 18px; border-radius: 20px; color: #86868b; }

        /* –°–ï–¢–ö–ê –ü–£–ë–õ–ò–ö–ê–¶–ò–ô */
        .grid { display: grid; gap: 25px; transition: 0.3s; }
        .grid.view-list { grid-template-columns: 1fr; }
        .grid.view-grid { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }

        .card {
            background: white; border-radius: 18px; padding: 24px;
            box-shadow: var(--card-shadow); transition: 0.3s;
            position: relative; border: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .card.recommended { border-left: 5px solid var(--primary); }

        .type-tag { font-size: 12px; font-weight: 600; color: var(--primary); text-transform: uppercase; margin-bottom: 8px; display: block; }

        .media-container {
            width: 100%; max-height: 380px; border-radius: 12px; overflow: hidden;
            margin: 15px 0; background: #000; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .media-container img, .media-container video { width: 100%; height: auto; max-height: 380px; object-fit: contain; }

        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥ –¥–ª—è —Å–µ—Ç–∫–∏ */
        .view-grid .media-container { max-height: 200px; }
        .view-grid .card { padding: 16px; }
        .view-grid h3 { font-size: 16px; height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

        .interest-tag {
            display: inline-block; background: #f5f5f7; color: #515154;
            padding: 5px 12px; border-radius: 8px; font-size: 12px; margin: 8px 6px 0 0;
            cursor: pointer; transition: 0.2s;
        }
        .interest-tag:hover { background: var(--primary); color: white; }

        .actions-bar { margin-top: auto; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f5f5f7; padding-top: 15px; }
        .action-btn {
            background: #f5f5f7; border: none; color: #1d1d1f;
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px; font-size: 13px;
        }
        .like-btn.active { background: #ff3b30; color: white; }

        /* –°–ê–ô–î–ë–ê–† */
        .sidebar-box { background: white; padding: 24px; border-radius: 18px; box-shadow: var(--card-shadow); position: sticky; top: 100px; }
        .sidebar-box h3 { margin-top: 0; font-size: 18px; margin-bottom: 15px; }

        /* –°–ö–ï–õ–ï–¢–û–ù–´ */
        @keyframes skeleton-pulse {
            0% { background-color: #e2e2e7; }
            50% { background-color: #f2f2f7; }
            100% { background-color: #e2e2e7; }
        }
        .skeleton-card { background: white; border-radius: 18px; padding: 24px; height: 320px; display: flex; flex-direction: column; gap: 15px; }
        .sk-box { background: #e2e2e7; border-radius: 8px; animation: skeleton-pulse 1.5s infinite ease-in-out; }

        .empty-state { grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: white; border-radius: 18px; border: 2px dashed #d2d2d7; color: #86868b; }

        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; }
            .sidebar { display: none; }
            .navbar { padding: 12px 20px; }
            .view-switcher { display: none; } /* –°–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        }

        .comments-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee; display: none; }
        .comment-item { display: flex; gap: 10px; margin-bottom: 12px; font-size: 13px; }
        .comment-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        .comment-bubble { background: #f5f5f7; padding: 10px; border-radius: 12px; flex-grow: 1; }
        .comment-input-area { display: flex; gap: 8px; margin-top: 15px; }
        .comment-input { flex-grow: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 18px; font-size: 13px; outline: none; }
        .comment-send-btn { border:none; background:none; cursor:pointer; font-size: 16px; transition: transform 0.2s; }
        .comment-send-btn:hover { transform: scale(1.2); }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="/" class="logo">TechPlatform</a>
    <div id="auth-section" class="user-menu"></div>
</nav>

<div class="container">
    <div class="search-container">
        <input type="text" id="global-search" class="global-search" oninput="handleSearch()" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞–≤—Ç–æ—Ä—É –∏–ª–∏ —Ç–µ–≥–∞–º...">
    </div>

    <div class="main-layout">
        <div class="content-area">
            <div class="post-stub" onclick="window.location.href='/create-post.html'">
                <div id="mini-avatar-placeholder"></div>
                <div class="post-stub-input">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∏–Ω–Ω–æ–≤–∞—Ü–∏–µ–π...</div>
            </div>

            <div class="category-bar">
                <button class="cat-btn active" onclick="setCategory('All', this)">–í—Å–µ</button>
                <button class="cat-btn" onclick="setCategory('Programming', this)">Programming</button>
                <button class="cat-btn" onclick="setCategory('Gadgets', this)">Gadgets</button>
                <button class="cat-btn" onclick="setCategory('Design', this)">Design</button>

                <div class="view-switcher">
                    <button class="view-btn" id="btn-view-list" onclick="setView('list')" title="–°–ø–∏—Å–æ–∫">‚ò∞</button>
                    <button class="view-btn" id="btn-view-grid" onclick="setView('grid')" title="–°–µ—Ç–∫–∞">‚äû</button>
                </div>
            </div>

            <div id="feed" class="grid view-list"></div>
        </div>

        <aside class="sidebar">
            <div class="sidebar-box">
                <h3>–¢—Ä–µ–Ω–¥–æ–≤—ã–µ —Ç–µ–≥–∏ ‚ú®</h3>
                <div id="trending-tags">
                    <p style="color: #86868b; font-size: 13px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–≥–æ–≤...</p>
                </div>
            </div>
        </aside>
    </div>
</div>

<script>
    let currentCategory = 'All';
    let allPosts = [];
    let currentView = localStorage.getItem('preferredView') || 'list';

    function getYouTubeID(url) {
        if (!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    async function checkAuth() {
        const userData = localStorage.getItem('user');
        if (!userData) { window.location.href = '/login.html'; return; }
        renderUserHeader(JSON.parse(userData));
        setView(currentView); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤–∏–¥
    }

    function setView(view) {
        currentView = view;
        localStorage.setItem('preferredView', view);
        const feed = document.getElementById('feed');

        const btnList = document.getElementById('btn-view-list');
        const btnGrid = document.getElementById('btn-view-grid');

        if (view === 'grid') {
            feed.classList.replace('view-list', 'view-grid');
            btnGrid.classList.add('active');
            btnList.classList.remove('active');
        } else {
            feed.classList.replace('view-grid', 'view-list');
            btnList.classList.add('active');
            btnGrid.classList.remove('active');
        }
    }

    function renderUserHeader(user) {
        const authSection = document.getElementById('auth-section');
        const miniPlaceholder = document.getElementById('mini-avatar-placeholder');
        const avatarHtml = user.avatarUrl
            ? `<img src="${user.avatarUrl}" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">`
            : `<div style="width:32px; height:32px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-size:14px;">${user.username[0].toUpperCase()}</div>`;

        if(miniPlaceholder) miniPlaceholder.innerHTML = user.avatarUrl
            ? `<img src="${user.avatarUrl}" style="width:35px; height:35px; border-radius:50%; object-fit:cover;">`
            : `üë§`;

        authSection.innerHTML = `
            <a href="/notifications.html" style="text-decoration:none; font-size:18px;">üîî</a>
            <a href="/profile.html" style="text-decoration:none; color:inherit; font-weight:600; display:flex; align-items:center; gap:8px;">
                ${avatarHtml} ${user.username}
            </a>
            <button onclick="logout()" style="background:none; border:1px solid #d2d2d7; padding:6px 12px; border-radius:8px; cursor:pointer; font-size:12px;">–í—ã—Ö–æ–¥</button>
        `;
    }

    function logout() { localStorage.removeItem('user'); window.location.href = '/login.html'; }

    function setCategory(cat, btn) {
        currentCategory = cat;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        fetchFeed();
    }

    function handleSearch() {
        const query = document.getElementById('global-search').value.toLowerCase();
        const filtered = allPosts.filter(post =>
            post.title.toLowerCase().includes(query) ||
            post.authorId?.username.toLowerCase().includes(query) ||
            post.tags.some(t => t.toLowerCase().includes(query))
        );
        renderPosts(filtered);
    }

    function showSkeletons() {
        const feed = document.getElementById('feed');
        feed.innerHTML = Array(3).fill(`
            <div class="skeleton-card">
                <div class="sk-box" style="width: 30%; height: 15px;"></div>
                <div class="sk-box" style="width: 70%; height: 25px;"></div>
                <div class="sk-box" style="width: 100%; height: 150px;"></div>
                <div class="sk-box" style="width: 100%; height: 15px;"></div>
            </div>
        `).join('');
    }

    async function fetchFeed() {
        const user = JSON.parse(localStorage.getItem('user'));
        const userId = user?.id || user?._id;
        showSkeletons();
        try {
            const response = await fetch(`/api/content?userId=${userId}&category=${currentCategory}`);
            allPosts = await response.json();
            setTimeout(() => {
                renderPosts(allPosts);
                updateTrendingTags(allPosts);
            }, 300);
        } catch (e) {
            document.getElementById('feed').innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</div>';
        }
    }

    function renderPosts(data) {
        const feed = document.getElementById('feed');
        const user = JSON.parse(localStorage.getItem('user'));
        const userId = user?.id || user?._id;

        if (data.length === 0) {
            feed.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 40px; margin-bottom: 10px;">üîé</div>
                    <h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</p>
                </div>`;
            return;
        }

        feed.innerHTML = data.map(item => {
            const isRec = user && item.tags?.some(tag => user.interests?.includes(tag));
            const userHasLiked = item.likedBy?.includes(userId);
            const ytId = getYouTubeID(item.body);

            return `
            <div class="card ${isRec ? 'recommended' : ''}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span class="type-tag">${item.mediaUrl ? (item.type === 'video' ? 'üé¨ –í–∏–¥–µ–æ' : 'üñºÔ∏è –§–æ—Ç–æ') : (ytId ? 'üé• YouTube' : 'üìÑ –°—Ç–∞—Ç—å—è')}</span>
                    <span style="font-size:11px; color:#86868b;">${item.category}</span>
                </div>

                <h3 style="margin:10px 0; cursor:pointer;" onclick="window.location.href='/post.html?id=${item._id}'">${item.title}</h3>

                <div onclick="window.location.href='/post.html?id=${item._id}'">
                    ${item.mediaUrl
                ? `<div class="media-container">${item.type === 'image' ? `<img src="${item.mediaUrl}">` : `<video src="${item.mediaUrl}" muted></video>`}</div>`
                : (ytId ? `<div class="media-container"><img src="https://img.youtube.com/vi/${ytId}/maxresdefault.jpg" onerror="this.src='https://img.youtube.com/vi/${ytId}/mqdefault.jpg'"></div>` : `<p style="color:#3a3a3c; font-size:14px; margin-bottom:15px;">${item.preview || (item.body ? item.body.substring(0,120)+'...' : '')}</p>`)
            }
                </div>

                <div class="tags-row">
                    ${(item.tags || []).map(t => `<span class="interest-tag" onclick="event.stopPropagation(); filterByTag('${t}')">#${t}</span>`).join('')}
                </div>

                <div class="actions-bar">
                    <span style="font-size:13px;">üë§ <strong>${item.authorId?.username || '–ê–≤—Ç–æ—Ä'}</strong></span>
                    <div style="display:flex; gap:8px;">
                        <button onclick="handleLike('${item._id}')" class="action-btn like-btn ${userHasLiked ? 'active' : ''}">
                            ‚ù§Ô∏è <span id="likes-${item._id}">${item.likes}</span>
                        </button>
                        <button onclick="toggleComments('${item._id}')" class="action-btn">
                            üí¨ <span>${item.stats?.commentsCount || 0}</span>
                        </button>
                    </div>
                </div>

                <div id="comments-block-${item._id}" class="comments-section">
                    <div id="comments-list-${item._id}"></div>
                    <div class="comment-input-area">
                        <input type="text" id="input-${item._id}" class="comment-input" placeholder="–í–∞—à–µ –º–Ω–µ–Ω–∏–µ...">
                        <button onclick="addComment('${item._id}')" class="comment-send-btn">üöÄ</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function updateTrendingTags(posts) {
        const tagsMap = {};
        posts.forEach(p => p.tags.forEach(t => tagsMap[t] = (tagsMap[t] || 0) + 1));
        const sorted = Object.keys(tagsMap).sort((a,b) => tagsMap[b] - tagsMap[a]).slice(0, 8);
        document.getElementById('trending-tags').innerHTML = sorted.map(t =>
            `<span class="interest-tag" style="display:block; margin:5px 0; padding:8px;" onclick="filterByTag('${t}')">#${t} (${tagsMap[t]})</span>`
        ).join('');
    }

    function filterByTag(tag) {
        document.getElementById('global-search').value = tag;
        handleSearch();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function handleLike(id) {
        const user = JSON.parse(localStorage.getItem('user'));
        const res = await fetch(`/api/content/${id}/like`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: user.id || user._id })
        });
        if(res.ok) {
            const data = await res.json();
            const btn = document.querySelector(`button[onclick="handleLike('${id}')"]`);
            btn.classList.toggle('active', data.isLiked);
            document.getElementById(`likes-${id}`).innerText = data.likes;
        }
    }

    async function toggleComments(id) {
        const block = document.getElementById(`comments-block-${id}`);
        block.style.display = block.style.display === 'block' ? 'none' : 'block';
        if(block.style.display === 'block') loadComments(id);
    }

    async function loadComments(postId) {
        const list = document.getElementById(`comments-list-${postId}`);
        const res = await fetch(`/api/comments/${postId}`);
        const comments = await res.json();
        list.innerHTML = comments.map(c => `
            <div class="comment-item">
                <img src="${c.authorId?.avatarUrl || 'https://via.placeholder.com/30'}" class="comment-avatar">
                <div class="comment-bubble">
                    <strong>${c.authorId?.username}</strong>
                    <div>${c.text}</div>
                </div>
            </div>
        `).join('');
    }

    async function addComment(postId) {
        const input = document.getElementById(`input-${postId}`);
        if(!input.value.trim()) return;
        const user = JSON.parse(localStorage.getItem('user'));
        const res = await fetch('/api/comments', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ postId, userId: user.id || user._id, text: input.value })
        });
        if(res.ok) { input.value = ''; loadComments(postId); fetchFeed(); }
    }

    checkAuth();
    fetchFeed();
</script>
</body>
</html>