<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Tech Platform - Feed</title>
    <style>
        :root { --primary: #0071e3; --bg: #f5f5f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; }

        .navbar { background: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 20px; font-weight: bold; color: var(--primary); text-decoration: none; }
        .user-menu { display: flex; align-items: center; gap: 20px; }

        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }

        .card {
            background: white;
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s, border 0.3s;
            position: relative;
            border: 2px solid transparent;
        }
        /* –°—Ç–∏–ª—å –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        .card.recommended {
            border: 2px solid var(--primary);
            background: #fbfdff;
        }
        .rec-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: bold;
        }

        .type-tag { font-size: 11px; font-weight: bold; text-transform: uppercase; color: var(--primary); }
        .interest-tag {
            display: inline-block;
            background: #e8f2ff;
            color: var(--primary);
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 11px;
            margin-right: 5px;
            margin-top: 10px;
        }

        .like-btn {
            background: #fff;
            border: 1px solid #ff3b30;
            color: #ff3b30;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        .like-btn.active {
            background: #ff3b30;
            color: #fff;
        }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="/" class="logo">TechPlatform</a>
    <div id="auth-section" class="user-menu"></div>
</nav>

<div class="container">
    <h1 id="page-title">–ò–Ω–Ω–æ–≤–∞—Ü–∏–∏ –≤ IT üöÄ</h1>
    <div id="feed" class="grid"></div>
</div>

<script>
    function renderUserHeader(user) {
        const authSection = document.getElementById('auth-section');
        if (!authSection) return;

        authSection.innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="/profile.html" style="text-decoration: none; color: inherit; font-weight: 500;">
                –ü—Ä–∏–≤–µ—Ç, üëã ${user.username}!
            </a>
            <button onclick="logout()" style="background: none; border: 1px solid #ff3b30; color: #ff3b30; padding: 5px 10px; border-radius: 5px; cursor: pointer;">–í—ã–π—Ç–∏</button>
        </div>
    `;
    }

    async function checkAuth() {
        const userData = localStorage.getItem('user');
        if (!userData) {
            window.location.href = '/login.html';
            return;
        }

        let user = JSON.parse(userData);
        renderUserHeader(user);

        try {
            const userId = user.id || user._id;
            const response = await fetch(`/api/users/${userId}`);

            if (response.ok) {
                const freshUser = await response.json();
                if (JSON.stringify(freshUser.interests) !== JSON.stringify(user.interests) ||
                    freshUser.username !== user.username) {

                    const updatedData = { ...freshUser, id: freshUser._id };
                    localStorage.setItem('user', JSON.stringify(updatedData));
                    renderUserHeader(updatedData);
                    // –ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –ª–µ–Ω—Ç—É
                    fetchFeed();
                }
            }
        } catch (err) {
            console.warn("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å");
        }
    }

    function logout() {
        localStorage.removeItem('user');
        window.location.href = '/login.html';
    }

    // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –¢–µ–ø–µ—Ä—å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ª–µ–Ω—Ç—É
    async function fetchFeed() {
        const userData = localStorage.getItem('user');
        const user = userData ? JSON.parse(userData) : null;
        const userId = user ? (user.id || user._id) : '';

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º userId —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º
        const response = await fetch(`/api/content?userId=${userId}`);
        const data = await response.json();
        const feedElement = document.getElementById('feed');

        feedElement.innerHTML = data.map(item => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ —Ö–æ—Ç—å –æ–¥–∏–Ω —Ç–µ–≥ –ø–æ—Å—Ç–∞ —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ —é–∑–µ—Ä–∞
            const isRec = user && item.tags && item.tags.some(tag => user.interests.includes(tag));
            const userHasLiked = user && item.likedBy && item.likedBy.includes(userId);

            return `
            <div class="card ${isRec ? 'recommended' : ''}">
                ${isRec ? '<div class="rec-badge">‚ú® –†–ï–ö–û–ú–ï–ù–î–£–ï–ú</div>' : ''}
                <div class="type-tag">${item.type === 'video' ? 'üé• –í–∏–¥–µ–æ' : 'üìÑ –°—Ç–∞—Ç—å—è'}</div>
                <h3>${item.title}</h3>
                <p style="color: #666; font-size: 14px;">${item.preview || item.content.substring(0, 100) + '...'}</p>

                <div class="tags-container">
                    ${(item.tags || []).map(t => `<span class="interest-tag">#${t}</span>`).join('')}
                </div>

                <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 13px; color: #888;">
                        üë§ ${item.authorId?.username || '–ê–≤—Ç–æ—Ä'}
                    </div>
                    <button onclick="handleLike('${item._id}')" class="like-btn ${userHasLiked ? 'active' : ''}">
                        ‚ù§Ô∏è <span id="likes-count-${item._id}">${item.likes || 0}</span>
                    </button>
                </div>
            </div>
            `;
        }).join('');
    }

    async function handleLike(contentId) {
        const storedUser = localStorage.getItem('user');
        if (!storedUser) return;
        const user = JSON.parse(storedUser);
        const userId = user.id || user._id;

        const res = await fetch(`/api/content/${contentId}/like`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: userId })
        });

        if (res.ok) {
            const data = await res.json();
            const countSpan = document.getElementById(`likes-count-${contentId}`);
            countSpan.innerText = data.likes;
            const btn = countSpan.parentElement;
            btn.classList.toggle('active', data.isLiked);
        }
    }

    // –ó–∞–ø—É—Å–∫
    checkAuth();
    fetchFeed();
</script>
</body>
</html>