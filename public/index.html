<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Platform - –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–∞—è –õ–µ–Ω—Ç–∞</title>
    <style>
        :root { --primary: #0071e3; --bg: #f5f5f7; --card-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; color: #1d1d1f; overflow-y: scroll; }

        .navbar { background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); padding: 12px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 0 rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 20px; font-weight: 700; color: var(--primary); text-decoration: none; letter-spacing: -0.5px; }
        .user-menu { display: flex; align-items: center; gap: 20px; }

        /* –ò–∫–æ–Ω–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        .notif-bell { position: relative; text-decoration: none; font-size: 20px; cursor: pointer; transition: 0.2s; }
        .notif-dot { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #ff3b30; border-radius: 50%; border: 2px solid #fff; display: none; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

        .search-container { margin-bottom: 30px; position: relative; }
        .global-search {
            width: 100%; padding: 16px 25px; border-radius: 16px; border: 1px solid #d2d2d7;
            font-size: 16px; outline: none; transition: 0.3s; background: white; box-sizing: border-box;
        }
        .global-search:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(0,113,227,0.1); }

        .main-layout { display: grid; grid-template-columns: 1fr 300px; gap: 30px; }

        .category-bar { display: flex; gap: 8px; margin-bottom: 20px; align-items: center; overflow-x: auto; padding-bottom: 8px; }
        .cat-btn {
            padding: 8px 18px; border-radius: 20px; border: none;
            background: #e8e8ed; cursor: pointer; font-weight: 500; transition: 0.2s; white-space: nowrap; color: #1d1d1f;
        }
        .cat-btn.active { background: var(--primary); color: white; }

        .view-switcher { display: flex; background: #e8e8ed; padding: 4px; border-radius: 12px; gap: 4px; margin-left: auto; }
        .view-btn { border: none; background: none; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 16px; transition: 0.2s; display: flex; align-items: center; opacity: 0.6; }
        .view-btn.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); opacity: 1; }

        .post-stub {
            background: white; border-radius: 16px; padding: 16px 20px; display: flex;
            align-items: center; gap: 12px; margin-bottom: 25px; cursor: pointer;
            box-shadow: var(--card-shadow); border: 1px solid rgba(0,0,0,0.05);
        }
        .post-stub-input { background: #f5f5f7; flex-grow: 1; padding: 10px 18px; border-radius: 20px; color: #86868b; }

        .grid { display: grid; gap: 25px; transition: 0.3s; }
        .grid.view-list { grid-template-columns: 1fr; }
        .grid.view-grid { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }

        .card {
            background: white; border-radius: 18px; padding: 24px;
            box-shadow: var(--card-shadow); transition: 0.3s;
            position: relative; border: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .card.recommended { border-left: 5px solid var(--primary); }

        .type-tag { font-size: 11px; font-weight: 700; color: var(--primary); text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 0.5px; }

        .media-container {
            width: calc(100% + 48px); margin: 0 -24px 15px -24px;
            max-height: 400px; overflow: hidden; background: #000;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: relative;
        }
        .view-grid .media-container { width: calc(100% + 32px); margin: 0 -16px 15px -16px; max-height: 200px; }

        .media-container img { width: 100%; height: 100%; object-fit: cover; }
        .play-overlay {
            position: absolute; background: rgba(0,0,0,0.6); color: white;
            width: 50px; height: 50px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 20px;
            border: 2px solid white; pointer-events: none;
        }

        .interest-tag {
            display: inline-block; background: #f5f5f7; color: #515154;
            padding: 5px 12px; border-radius: 8px; font-size: 12px; margin: 8px 6px 0 0;
            cursor: pointer; transition: 0.2s;
        }
        .interest-tag:hover { background: var(--primary); color: white; }

        .actions-bar { margin-top: auto; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f5f5f7; padding-top: 15px; }
        .action-btn {
            background: #f5f5f7; border: none; color: #1d1d1f;
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px; font-size: 13px; transition: 0.2s;
        }
        .like-btn.active { background: #ff3b30; color: white; }

        .comments-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee; display: none; }
        .comment-item { display: flex; gap: 10px; margin-bottom: 12px; font-size: 13px; }
        .comment-bubble { background: #f5f5f7; padding: 10px; border-radius: 12px; flex-grow: 1; }

        .comment-input-area { display: flex; gap: 8px; margin-top: 15px; padding-top: 10px; border-top: 1px solid #f5f5f7; }
        .comment-input { flex-grow: 1; padding: 8px 15px; border: 1px solid #d2d2d7; border-radius: 20px; outline: none; font-size: 13px; }
        .comment-send-btn { border: none; background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .comment-send-btn:hover { transform: scale(1.1); }

        .sidebar-box { background: white; padding: 24px; border-radius: 18px; box-shadow: var(--card-shadow); position: sticky; top: 100px; }
        .sidebar-box h3 { margin-top: 0; font-size: 18px; margin-bottom: 15px; }

        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; }
            .sidebar { display: none; }
            .navbar { padding: 12px 20px; }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="/" class="logo">TechPlatform</a>
    <div id="auth-section" class="user-menu"></div>
</nav>

<div class="container">
    <div class="search-container">
        <input type="text" id="global-search" class="global-search" oninput="handleSearch()" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞–≤—Ç–æ—Ä—É –∏–ª–∏ —Ç–µ–≥–∞–º...">
    </div>

    <div class="main-layout">
        <div class="content-area">
            <div class="post-stub" onclick="window.location.href='/create-post.html'">
                <div id="mini-avatar-placeholder"></div>
                <div class="post-stub-input">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∏–Ω–Ω–æ–≤–∞—Ü–∏–µ–π...</div>
            </div>

            <div class="category-bar">
                <button class="cat-btn active" onclick="setCategory('All', this)">–í—Å–µ</button>
                <button class="cat-btn" onclick="setCategory('Programming', this)">Programming</button>
                <button class="cat-btn" onclick="setCategory('Gadgets', this)">Gadgets</button>
                <button class="cat-btn" onclick="setCategory('Design', this)">Design</button>

                <div class="view-switcher">
                    <button class="view-btn" id="btn-view-list" onclick="setView('list')">‚ò∞</button>
                    <button class="view-btn" id="btn-view-grid" onclick="setView('grid')">‚äû</button>
                </div>
            </div>

            <div id="feed" class="grid view-list"></div>
        </div>

        <aside class="sidebar">
            <div class="sidebar-box">
                <h3>–¢—Ä–µ–Ω–¥–æ–≤—ã–µ —Ç–µ–≥–∏ ‚ú®</h3>
                <div id="trending-tags"></div>
            </div>
        </aside>
    </div>
</div>

<script>
    let currentCategory = 'All';
    let allPosts = [];
    let currentView = localStorage.getItem('preferredView') || 'list';
    const currentUser = JSON.parse(localStorage.getItem('user'));

    function getYouTubeID(url) {
        if (!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    async function checkAuth() {
        if (!currentUser) { window.location.href = '/login.html'; return; }
        renderUserHeader(currentUser);
        setView(currentView);
        checkNewNotifications();
    }

    function renderUserHeader(user) {
        const authSection = document.getElementById('auth-section');
        const miniPlaceholder = document.getElementById('mini-avatar-placeholder');
        const avatarHtml = user.avatarUrl
            ? `<img src="${user.avatarUrl}" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">`
            : `<div style="width:32px; height:32px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-size:14px;">${user.username[0]}</div>`;

        if(miniPlaceholder) miniPlaceholder.innerHTML = avatarHtml;

        authSection.innerHTML = `
            <a href="/notifications.html" class="notif-bell" id="notif-bell">
                üîî<span class="notif-dot" id="notif-dot"></span>
            </a>
            <a href="/profile.html" style="text-decoration:none; color:inherit; font-weight:600; display:flex; align-items:center; gap:8px;">
                ${avatarHtml} ${user.username}
            </a>
            <button onclick="logout()" style="background:none; border:1px solid #d2d2d7; padding:6px 12px; border-radius:8px; cursor:pointer; font-size:12px;">–í—ã—Ö–æ–¥</button>
        `;
    }

    async function checkNewNotifications() {
        try {
            const userId = currentUser.id || currentUser._id;
            const res = await fetch(`/api/notifications/${userId}`);
            const data = await res.json();
            const hasUnread = data.some(n => !n.read);
            if (hasUnread) document.getElementById('notif-dot').style.display = 'block';
        } catch (e) {}
    }

    function logout() { localStorage.removeItem('user'); localStorage.removeItem('token'); window.location.href = '/login.html'; }

    function setView(view) {
        currentView = view;
        localStorage.setItem('preferredView', view);
        const feed = document.getElementById('feed');
        const btnList = document.getElementById('btn-view-list');
        const btnGrid = document.getElementById('btn-view-grid');

        if (view === 'grid') {
            feed.classList.remove('view-list');
            feed.classList.add('view-grid');
            btnGrid.classList.add('active');
            btnList.classList.remove('active');
        } else {
            feed.classList.remove('view-grid');
            feed.classList.add('view-list');
            btnList.classList.add('active');
            btnGrid.classList.remove('active');
        }
    }

    function setCategory(cat, btn) {
        currentCategory = cat;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        fetchFeed();
    }

    async function fetchFeed() {
        try {
            const res = await fetch(`/api/content?category=${currentCategory}`);
            allPosts = await res.json();
            renderPosts(allPosts);
            updateTrendingTags(allPosts);
        } catch (e) { console.error(e); }
    }

    function renderPosts(data) {
        const feed = document.getElementById('feed');
        const userId = currentUser?.id || currentUser?._id;

        if (!data.length) {
            feed.innerHTML = '<div class="empty-state">–ü—É—Å—Ç–æ</div>';
            return;
        }

        // --- –õ–û–ì–ò–ö–ê –°–û–†–¢–ò–†–û–í–ö–ò –ü–û –ò–ù–¢–ï–†–ï–°–ê–ú ---
        const recommended = [];
        const normal = [];

        data.forEach(item => {
            const hasMatch = currentUser?.interests?.some(interest =>
                item.tags.map(t => t.toLowerCase()).includes(interest.toLowerCase())
            );
            if (hasMatch) recommended.push(item);
            else normal.push(item);
        });

        const sortedData = [...recommended, ...normal];

        feed.innerHTML = sortedData.map(item => {
            const isRec = currentUser?.interests?.some(interest =>
                item.tags.map(t => t.toLowerCase()).includes(interest.toLowerCase())
            );
            const ytId = getYouTubeID(item.mediaUrl) || getYouTubeID(item.body);
            const userHasLiked = item.likedBy?.includes(userId);

            let typeLabel = 'üìÑ –°—Ç–∞—Ç—å—è';
            if (item.type === 'video' || ytId) typeLabel = 'üé¨ –í–∏–¥–µ–æ';
            if (item.type === 'image') typeLabel = 'üñºÔ∏è –§–æ—Ç–æ';

            return `
            <div class="card ${isRec ? 'recommended' : ''}" id="post-${item._id}">
                ${isRec ? '<span style="font-size: 10px; color: var(--primary); font-weight: 800; margin-bottom: 5px; display: block;">‚ú® –†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–û</span>' : ''}
                <span class="type-tag">${typeLabel}</span>
                <h3 style="margin:0 0 10px 0; cursor:pointer;" onclick="location.href='/post.html?id=${item._id}'">${item.title}</h3>

                <div onclick="location.href='/post.html?id=${item._id}'">
                    ${item.mediaUrl && !ytId && item.type !== 'video'
                ? `<div class="media-container"><img src="${item.mediaUrl}"></div>`
                : (ytId
                    ? `<div class="media-container">
                                 <img src="https://img.youtube.com/vi/${ytId}/maxresdefault.jpg" onerror="this.src='https://img.youtube.com/vi/${ytId}/mqdefault.jpg'">
                                 <div class="play-overlay">‚ñ∂</div>
                               </div>`
                    : `<p style="color:#424245; font-size:14px; line-height: 1.5;">${item.preview || ''}</p>`)
            }
                </div>

                <div>
                    ${item.tags.map(t => `<span class="interest-tag" onclick="filterByTag('${t}')">#${t}</span>`).join('')}
                </div>

                <div class="actions-bar">
                    <span style="font-size:13px; color:#86868b;">üë§ <b>${item.authorId?.username || 'User'}</b></span>
                    <div style="display:flex; gap:8px;">
                        <button onclick="handleLike('${item._id}')" class="action-btn like-btn ${userHasLiked ? 'active' : ''}" id="like-btn-${item._id}">
                            ‚ù§Ô∏è <span id="likes-count-${item._id}">${item.likes}</span>
                        </button>
                        <button onclick="toggleComments('${item._id}')" class="action-btn">
                            üí¨ <span id="comm-count-${item._id}">${item.stats?.commentsCount || 0}</span>
                        </button>
                    </div>
                </div>

                <div id="comments-block-${item._id}" class="comments-section">
                    <div id="comments-list-${item._id}"></div>
                    <div class="comment-input-area">
                        <input type="text" id="input-${item._id}" class="comment-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
                        <button onclick="addCommentMain('${item._id}')" class="comment-send-btn">üöÄ</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    async function handleLike(id) {
        const userId = currentUser.id || currentUser._id;
        try {
            const res = await fetch(`/api/content/${id}/like`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId: userId })
            });
            if (res.ok) {
                const data = await res.json();
                const btn = document.getElementById(`like-btn-${id}`);
                const span = document.getElementById(`likes-count-${id}`);

                // –ë–µ—Å—à–æ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                btn.classList.toggle('active', data.isLiked);
                span.innerText = data.likes;

                // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
                const post = allPosts.find(p => p._id === id);
                if(post) {
                    post.likes = data.likes;
                    if(data.isLiked) post.likedBy.push(userId);
                    else post.likedBy = post.likedBy.filter(uid => uid !== userId);
                }
            }
        } catch (e) { console.error(e); }
    }

    async function toggleComments(id) {
        const block = document.getElementById(`comments-block-${id}`);
        block.style.display = block.style.display === 'block' ? 'none' : 'block';
        if(block.style.display === 'block') loadCommentsMain(id);
    }

    async function loadCommentsMain(postId) {
        const list = document.getElementById(`comments-list-${postId}`);
        try {
            const res = await fetch(`/api/comments/${postId}`);
            const comments = await res.json();
            list.innerHTML = comments.map(c => `
                <div class="comment-item">
                    <div class="comment-bubble"><b>${c.authorId?.username || 'User'}:</b> ${c.text}</div>
                </div>
            `).join('');
        } catch (e) { console.error(e); }
    }

    async function addCommentMain(postId) {
        const input = document.getElementById(`input-${postId}`);
        if(!input.value.trim() || !currentUser) return;
        try {
            const res = await fetch('/api/comments', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ postId, userId: currentUser.id || currentUser._id, text: input.value.trim() })
            });
            if(res.ok) {
                input.value = '';
                loadCommentsMain(postId);
                const countSpan = document.getElementById(`comm-count-${postId}`);
                countSpan.innerText = parseInt(countSpan.innerText) + 1;
            }
        } catch (e) { console.error(e); }
    }

    function updateTrendingTags(posts) {
        const tagsMap = {};
        posts.forEach(p => p.tags.forEach(t => tagsMap[t] = (tagsMap[t] || 0) + 1));
        const sorted = Object.keys(tagsMap).sort((a,b) => tagsMap[b] - tagsMap[a]).slice(0, 6);
        document.getElementById('trending-tags').innerHTML = sorted.map(t =>
            `<span class="interest-tag" style="display:block; margin:5px 0;" onclick="filterByTag('${t}')">#${t}</span>`
        ).join('');
    }

    function handleSearch() {
        const query = document.getElementById('global-search').value.toLowerCase();
        const filtered = allPosts.filter(p => p.title.toLowerCase().includes(query) || p.tags.some(t => t.includes(query)));
        renderPosts(filtered);
    }

    function filterByTag(tag) {
        document.getElementById('global-search').value = tag;
        handleSearch();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    checkAuth();
    fetchFeed();
</script>
</body>
</html>