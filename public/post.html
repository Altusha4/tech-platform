<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ | TechPlatform</title>
  <style>
    :root { --primary: #0071e3; --bg: #f5f5f7; --red: #ff3b30; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —á—Ç–µ–Ω–∏—è */
    #progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: rgba(255,255,255,0.2); z-index: 2000; }
    #progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s ease; }

    .post-container { max-width: 800px; margin: 20px auto; background: white; padding: 40px; border-radius: 28px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); }

    /* –®–∞–ø–∫–∞ –ø–æ—Å—Ç–∞ */
    .post-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
    .meta-info { color: #86868b; font-size: 14px; margin-bottom: 8px; }

    /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫–ª–∞–¥–æ–∫ */
    .bookmark-btn { background: #f5f5f7; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
    .bookmark-btn:hover { background: #e8e8ed; transform: scale(1.1); }
    .bookmark-btn.active { background: var(--primary); color: white; }

    .full-media { width: 100%; border-radius: 20px; margin-bottom: 30px; background: #000; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .full-media video, .full-media img { width: 100%; display: block; }
    .full-media iframe { width: 100%; aspect-ratio: 16/9; border: none; }

    .post-body { line-height: 1.8; font-size: 19px; color: #1d1d1f; margin-bottom: 40px; white-space: pre-line; }
    .interest-tag { display: inline-block; background: #f5f5f7; color: #515154; padding: 6px 14px; border-radius: 10px; font-size: 14px; margin-right: 8px; text-decoration: none; transition: 0.2s; }
    .interest-tag:hover { background: var(--primary); color: white; }

    .back-link { display: inline-block; margin-bottom: 25px; text-decoration: none; color: var(--primary); font-weight: 600; font-size: 15px; }

    /* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ */
    .comments-section { margin-top: 50px; border-top: 1px solid #f5f5f7; padding-top: 35px; }
    .comment-item { display: flex; gap: 15px; margin-bottom: 20px; }
    .comment-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .comment-bubble { background: #f5f5f7; padding: 15px 20px; border-radius: 20px; flex-grow: 1; }
    .comment-bubble strong { display: block; font-size: 14px; margin-bottom: 5px; color: #1d1d1f; }

    .comment-input-area { display: flex; gap: 12px; margin-top: 30px; background: white; padding: 5px; border-radius: 30px; border: 1px solid #d2d2d7; }
    .comment-input { flex-grow: 1; border: none; padding: 12px 20px; border-radius: 30px; outline: none; font-size: 15px; }
    .comment-send-btn { background: var(--primary); color: white; border: none; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; transition: 0.2s; }
    .comment-send-btn:hover { transform: scale(1.1); }

    .delete-btn { cursor: pointer; opacity: 0.3; transition: 0.2s; font-size: 14px; }
    .delete-btn:hover { opacity: 1; color: var(--red); }
  </style>
</head>
<body>

<div id="progress-container"><div id="progress-bar"></div></div>

<div class="post-container">
  <a href="/" class="back-link">‚Üê –ù–∞–∑–∞–¥ –≤ –ª–µ–Ω—Ç—É</a>

  <div id="post-view">
    <p style="text-align: center; color: #888;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...</p>
  </div>

  <div class="comments-section">
    <h3 style="margin-bottom: 25px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (<span id="comm-total">0</span>)</h3>
    <div id="comments-list"></div>

    <div class="comment-input-area">
      <input type="text" id="new-comment-text" class="comment-input" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º–∏ –º—ã—Å–ª—è–º–∏...">
      <button onclick="addComment()" class="comment-send-btn">üöÄ</button>
    </div>
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const postId = urlParams.get('id');
  const currentUser = JSON.parse(localStorage.getItem('user'));

  // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —á—Ç–µ–Ω–∏—è
  window.onscroll = () => {
    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrolled = (winScroll / height) * 100;
    document.getElementById("progress-bar").style.width = scrolled + "%";
  };

  function getYouTubeEmbedUrl(url) {
    if (!url) return null;
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? `https://www.youtube.com/embed/${match[2]}` : null;
  }

  async function loadFullPost() {
    if (!postId) { window.location.href = '/'; return; }
    try {
      const res = await fetch(`/api/content/single/${postId}`);
      const post = await res.json();
      const ytUrl = getYouTubeEmbedUrl(post.body);

      const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
      const isBookmarked = bookmarks.includes(postId);

      document.title = `${post.title} | TechPlatform`;
      document.getElementById('post-view').innerHTML = `
        <div class="post-header">
          <div>
            <div class="meta-info">${post.category || '–û–±—â–µ–µ'} ‚Ä¢ ${new Date(post.createdAt).toLocaleDateString()}</div>
            <h1 style="margin: 0; font-size: 34px; letter-spacing: -0.5px;">${post.title}</h1>
          </div>
          <button onclick="toggleBookmark('${post._id}')" class="bookmark-btn ${isBookmarked ? 'active' : ''}" id="book-btn">
            ${isBookmarked ? 'üîñ' : 'üìë'}
          </button>
        </div>

        <div class="full-media">
          ${post.mediaUrl
              ? (post.type === 'video' ? `<video src="${post.mediaUrl}" controls></video>` : `<img src="${post.mediaUrl}">`)
              : (ytUrl ? `<iframe src="${ytUrl}" allowfullscreen></iframe>` : '')
      }
        </div>

        <div class="post-body">
          ${!ytUrl && post.body ? post.body : (post.preview || '–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞')}
        </div>

        <div style="margin-bottom: 30px;">
          ${(post.tags || []).map(t => `<span class="interest-tag">#${t}</span>`).join('')}
        </div>

        <div style="font-size: 14px; color: #86868b; display: flex; align-items: center; gap: 10px;">
          <img src="${post.authorId?.avatarUrl || 'https://via.placeholder.com/30'}" style="width:30px; height:30px; border-radius:50%;">
          <span>–ê–≤—Ç–æ—Ä: <strong>${post.authorId?.username || 'Tech Expert'}</strong></span>
        </div>
      `;

      loadComments();
    } catch (e) {
      document.getElementById('post-view').innerHTML = "<h2>–ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h2>";
    }
  }

  // –õ–æ–≥–∏–∫–∞ –∑–∞–∫–ª–∞–¥–æ–∫ (—á–µ—Ä–µ–∑ LocalStorage)
  function toggleBookmark(id) {
    let bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
    const btn = document.getElementById('book-btn');

    if (bookmarks.includes(id)) {
      bookmarks = bookmarks.filter(b => b !== id);
      btn.classList.remove('active');
      btn.innerText = 'üìë';
    } else {
      bookmarks.push(id);
      btn.classList.add('active');
      btn.innerText = 'üîñ';
    }

    localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
  }

  async function loadComments() {
    const list = document.getElementById('comments-list');
    const countSpan = document.getElementById('comm-total');
    const currentUserId = currentUser ? (currentUser.id || currentUser._id) : null;

    try {
      const res = await fetch(`/api/comments/${postId}`);
      const comments = await res.json();
      countSpan.innerText = comments.length;

      if (comments.length === 0) {
        list.innerHTML = "<p style='color: #888;'>–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ. –û—Å—Ç–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π!</p>";
        return;
      }

      list.innerHTML = comments.map(c => {
        const isMyComment = currentUserId && (c.authorId?._id === currentUserId || c.authorId === currentUserId);
        return `
          <div class="comment-item" id="comment-${c._id}">
            <img src="${c.authorId?.avatarUrl || 'https://via.placeholder.com/40'}" class="comment-avatar">
            <div class="comment-bubble">
              <div style="display: flex; justify-content: space-between;">
                <strong>${c.authorId?.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</strong>
                ${isMyComment ? `<span class="delete-btn" onclick="deleteComment('${c._id}')">üóëÔ∏è</span>` : ''}
              </div>
              <div style="margin-top: 5px;">${c.text}</div>
            </div>
          </div>
        `;
      }).join('');
    } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"; }
  }

  async function addComment() {
    const input = document.getElementById('new-comment-text');
    if (!input.value.trim() || !currentUser) return;
    try {
      const res = await fetch('/api/comments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ postId, userId: currentUser.id || currentUser._id, text: input.value.trim() })
      });
      if (res.ok) { input.value = ''; loadComments(); }
    } catch (e) { console.error(e); }
  }

  async function deleteComment(commentId) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
    try {
      const res = await fetch(`/api/comments/${commentId}`, { method: 'DELETE' });
      if (res.ok) loadComments();
    } catch (e) { alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è"); }
  }

  document.getElementById('new-comment-text').addEventListener('keypress', (e) => { if (e.key === 'Enter') addComment(); });

  loadFullPost();
</script>
</body>
</html>