<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ | TechPlatform</title>
  <style>
    :root { --primary: #0071e3; --bg: #f5f5f7; --red: #ff3b30; --card-shadow: 0 4px 25px rgba(0,0,0,0.05); }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1d1d1f; overflow-y: scroll; }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —á—Ç–µ–Ω–∏—è */
    #progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: rgba(255,255,255,0.2); z-index: 2000; }
    #progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s ease; }

    .post-container { max-width: 800px; margin: 20px auto; background: white; padding: 40px; border-radius: 28px; box-shadow: var(--card-shadow); opacity: 0; transform: translateY(10px); transition: 0.5s ease; }
    .post-container.loaded { opacity: 1; transform: translateY(0); }

    .post-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; }
    .meta-info { color: #86868b; font-size: 14px; margin-bottom: 8px; font-weight: 500; }

    .bookmark-btn { background: #f5f5f7; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
    .bookmark-btn:hover { background: #e8e8ed; transform: scale(1.1); }
    .bookmark-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3); }

    .full-media { width: 100%; border-radius: 20px; margin-bottom: 30px; background: #000; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .full-media video, .full-media img { width: 100%; display: block; max-height: 550px; object-fit: contain; }
    .full-media iframe { width: 100%; aspect-ratio: 16/9; border: none; display: block; }

    .post-body { line-height: 1.8; font-size: 19px; color: #1d1d1f; margin-bottom: 40px; white-space: pre-line; word-wrap: break-word; }

    .interest-tag { display: inline-block; background: #f5f5f7; color: #515154; padding: 6px 14px; border-radius: 10px; font-size: 14px; margin-right: 8px; text-decoration: none; transition: 0.2s; font-weight: 500; }
    .interest-tag:hover { background: var(--primary); color: white; }

    .back-link { display: inline-block; margin-bottom: 25px; text-decoration: none; color: var(--primary); font-weight: 600; font-size: 15px; transition: 0.2s; }
    .back-link:hover { opacity: 0.7; }

    .comments-section { margin-top: 50px; border-top: 1px solid #f5f5f7; padding-top: 35px; }
    .comment-item { display: flex; gap: 15px; margin-bottom: 20px; animation: fadeIn 0.4s ease; transition: 0.3s; }
    .comment-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; background: #fff; }
    .comment-bubble { background: #f5f5f7; padding: 15px 20px; border-radius: 20px; flex-grow: 1; position: relative; }
    .comment-bubble strong { display: block; font-size: 14px; margin-bottom: 5px; color: #1d1d1f; }

    .comment-input-area { display: flex; gap: 12px; margin-top: 30px; background: white; padding: 6px; border-radius: 30px; border: 1px solid #d2d2d7; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .comment-input { flex-grow: 1; border: none; padding: 10px 18px; border-radius: 30px; outline: none; font-size: 15px; font-family: inherit; }
    .comment-send-btn { background: var(--primary); color: white; border: none; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
    .comment-send-btn:hover { transform: scale(1.1); background: #0077ed; }

    .delete-btn { cursor: pointer; opacity: 0.5; transition: 0.2s; font-size: 14px; margin-left: 10px; }
    .delete-btn:hover { opacity: 1; color: var(--red); transform: scale(1.2); }

    .skeleton { background: #e2e2e7; animation: pulse 1.5s infinite ease-in-out; border-radius: 8px; }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 600px) {
      .post-container { padding: 25px 20px; margin: 10px; border-radius: 20px; }
      .post-body { font-size: 17px; }
    }
  </style>
</head>
<body>

<div id="progress-container"><div id="progress-bar"></div></div>

<div class="post-container" id="main-container">
  <a href="/" class="back-link">‚Üê –ù–∞–∑–∞–¥ –≤ –ª–µ–Ω—Ç—É</a>

  <div id="post-view">
    <div class="meta-info skeleton" style="width: 150px; height: 14px; margin-bottom: 15px;"></div>
    <div class="skeleton" style="width: 80%; height: 36px; margin-bottom: 30px;"></div>
    <div class="full-media skeleton" style="height: 400px;"></div>
    <div class="skeleton" style="width: 100%; height: 18px; margin-bottom: 10px;"></div>
    <div class="skeleton" style="width: 60%; height: 18px;"></div>
  </div>

  <div class="comments-section">
    <h3 style="margin-bottom: 25px;">–î–∏—Å–∫—É—Å—Å–∏—è (<span id="comm-total">0</span>)</h3>
    <div id="comments-list"></div>

    <div class="comment-input-area">
      <input type="text" id="new-comment-text" class="comment-input" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º–∏ –º—ã—Å–ª—è–º–∏...">
      <button onclick="addComment()" class="comment-send-btn">üöÄ</button>
    </div>
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const postId = urlParams.get('id');
  const currentUser = JSON.parse(localStorage.getItem('user'));

  window.onscroll = () => {
    const winScroll = document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrolled = height > 0 ? (winScroll / height) * 100 : 0;
    const progressBar = document.getElementById("progress-bar");
    if (progressBar) progressBar.style.width = scrolled + "%";
  };

  function getYouTubeID(url) {
    if (!url) return null;
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  }

  async function loadFullPost() {
    if (!postId || postId === 'null') {
      document.getElementById('post-view').innerHTML = "<h2>–û—à–∏–±–∫–∞: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞</h2>";
      document.getElementById('main-container').classList.add('loaded');
      return;
    }

    try {
      const res = await fetch(`/api/content/single/${postId}`);
      if (!res.ok) throw new Error("404");

      const post = await res.json();
      const ytId = getYouTubeID(post.mediaUrl) || getYouTubeID(post.body);
      const ytEmbedUrl = ytId ? `https://www.youtube.com/embed/${ytId}` : null;

      const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
      const isBookmarked = bookmarks.includes(postId);

      document.title = `${post.title} | TechPlatform`;

      let mediaHtml = '';
      if (ytEmbedUrl) {
        mediaHtml = `<div class="full-media"><iframe src="${ytEmbedUrl}" allowfullscreen></iframe></div>`;
      } else if (post.mediaUrl) {
        mediaHtml = post.type === 'video'
                ? `<div class="full-media"><video src="${post.mediaUrl}" controls></video></div>`
                : `<div class="full-media"><img src="${post.mediaUrl}" alt="Media"></div>`;
      }

      let bodyText = post.body || '';
      if (ytId) bodyText = bodyText.replace(/https?:\/\/(www\.)?(youtube\.com|youtu\.be)\/\S+/g, '');

      document.getElementById('post-view').innerHTML = `
        <div class="post-header">
          <div>
            <div class="meta-info">${post.category || '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏'} ‚Ä¢ ${new Date(post.createdAt).toLocaleDateString('ru-RU')}</div>
            <h1 style="margin: 0; font-size: 32px; letter-spacing: -0.8px; line-height: 1.1;">${post.title}</h1>
          </div>
          <button onclick="toggleBookmark('${post._id}')" class="bookmark-btn ${isBookmarked ? 'active' : ''}" id="book-btn">
            ${isBookmarked ? 'üîñ' : 'üìë'}
          </button>
        </div>
        ${mediaHtml}
        <div class="post-body">${bodyText || post.preview || '–¢–µ–∫—Å—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.'}</div>
        <div style="margin-bottom: 35px;">
          ${(post.tags || []).map(t => `<span class="interest-tag">#${t}</span>`).join('')}
        </div>
        <div style="background: #f5f5f7; padding: 20px; border-radius: 20px; display: flex; align-items: center; gap: 15px; border: 1px solid rgba(0,0,0,0.03);">
          <img src="${post.authorId?.avatarUrl || ''}" onerror="this.src='https://ui-avatars.com/api/?name='+encodeURIComponent('${post.authorId?.username || 'U'}')" style="width:50px; height:50px; border-radius:50%; background: #fff; border: 1px solid #ddd; object-fit: cover;">
          <div>
            <div style="font-size: 12px; color: #86868b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">–ê–≤—Ç–æ—Ä</div>
            <strong style="font-size: 17px; color: #1d1d1f;">${post.authorId?.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</strong>
          </div>
        </div>
      `;

      document.getElementById('main-container').classList.add('loaded');
      loadComments();
    } catch (e) {
      document.getElementById('post-view').innerHTML = "<h2 style='text-align:center;'>–ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h2>";
      document.getElementById('main-container').classList.add('loaded');
    }
  }

  function toggleBookmark(id) {
    let bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
    const btn = document.getElementById('book-btn');
    if (bookmarks.includes(id)) {
      bookmarks = bookmarks.filter(b => b !== id);
      btn.classList.remove('active');
      btn.innerText = 'üìë';
    } else {
      bookmarks.push(id);
      btn.classList.add('active');
      btn.innerText = 'üîñ';
    }
    localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
  }

  async function loadComments() {
    const list = document.getElementById('comments-list');
    const countSpan = document.getElementById('comm-total');
    const currentUserId = currentUser ? (currentUser._id || currentUser.id) : null;

    try {
      const res = await fetch(`/api/comments/${postId}`);
      const comments = await res.json();
      countSpan.innerText = comments.length;

      if (!comments.length) {
        list.innerHTML = "<p style='color: #888; text-align: center; padding: 20px 0;'>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>";
        return;
      }

      list.innerHTML = comments.map(c => {
        const author = c.authorId || {};
        const authorIdStr = author._id || author;
        const isMyComment = currentUserId && authorIdStr === String(currentUserId);
        const avatar = author.avatarUrl || `https://ui-avatars.com/api/?name=${author.username || 'U'}`;

        return `
          <div class="comment-item" id="comment-${c._id}">
            <img src="${avatar}" class="comment-avatar">
            <div class="comment-bubble">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong>${author.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</strong>
                ${isMyComment ? `<span class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å" onclick="deleteComment('${c._id}')">üóëÔ∏è</span>` : ''}
              </div>
              <div style="margin-top: 6px; color: #3a3a3c;">${c.text}</div>
            </div>
          </div>
        `;
      }).join('');
    } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏."; }
  }

  async function addComment() {
    const input = document.getElementById('new-comment-text');
    const text = input.value.trim();
    if (!text || !currentUser) {
      if(!currentUser) alert("–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç");
      return;
    }

    try {
      const res = await fetch('/api/comments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ postId, userId: currentUser._id || currentUser.id, text })
      });
      if (res.ok) {
        input.value = '';
        await loadComments(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ä–∞–∑—É
      }
    } catch (e) { alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"); }
  }

  async function deleteComment(commentId) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?")) return;
    try {
      const res = await fetch(`/api/comments/${commentId}`, { method: 'DELETE' });
      if (res.ok) {
        document.getElementById(`comment-${commentId}`).remove();
        const countSpan = document.getElementById('comm-total');
        countSpan.innerText = Math.max(0, parseInt(countSpan.innerText) - 1);
      }
    } catch (e) { alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è"); }
  }

  document.getElementById('new-comment-text').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') addComment();
  });

  loadFullPost();
</script>
</body>
</html>