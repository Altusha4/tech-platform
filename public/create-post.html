<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Post | TechPlatform</title>
  <style>
    :root { --primary: #0071e3; --bg: #f5f5f7; --border: #d2d2d7; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1d1d1f; }
    .editor-container { max-width: 700px; margin: 40px auto; background: white; padding: 40px; border-radius: 28px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
    .back-link { text-decoration: none; color: var(--primary); font-weight: 600; display: inline-block; margin-bottom: 25px; font-size: 15px; }
    h1 { font-size: 32px; letter-spacing: -0.8px; margin-bottom: 30px; }
    label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #1d1d1f; }
    input, textarea, select {
      width: 100%; padding: 14px; margin-bottom: 20px;
      border: 1px solid var(--border); border-radius: 12px;
      font-size: 16px; box-sizing: border-box; font-family: inherit; outline: none;
      transition: 0.2s; background: #fafafa;
    }
    input:focus, textarea:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px rgba(0,113,227,0.1); }
    textarea { height: 120px; resize: none; }
    .file-input-wrapper {
      border: 2px dashed var(--border); padding: 30px; text-align: center;
      border-radius: 16px; margin-bottom: 20px; cursor: pointer; transition: 0.2s;
      position: relative; background: #fafafa;
    }
    .file-input-wrapper:hover { border-color: var(--primary); background: #fff; }
    #image-preview { width: 100%; max-height: 300px; object-fit: cover; border-radius: 12px; display: none; margin-top: 15px; }
    .tag-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
    .tag-checkbox { display: none; }
    .tag-label {
      padding: 10px 20px; border: 1px solid var(--border); border-radius: 20px;
      cursor: pointer; font-size: 13px; transition: 0.2s; background: #fff; font-weight: 500;
    }
    .tag-checkbox:checked + .tag-label { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,113,227,0.2); }
    .publish-btn {
      width: 100%; background: var(--primary); color: white; border: none;
      padding: 18px; border-radius: 14px; font-size: 18px; font-weight: 700;
      cursor: pointer; transition: 0.3s;
    }
    .publish-btn:hover { background: #0077ed; transform: translateY(-2px); }
    .publish-btn:disabled { background: #d2d2d7; cursor: not-allowed; transform: none; }
    .hidden { display: none; }
  </style>
</head>
<body>

<div class="editor-container">
  <a href="/" class="back-link">‚Üê Back to Feed</a>
  <h1 id="page-title">Create Innovation</h1>

  <label>Post Title</label>
  <input type="text" id="post-title" placeholder="Ex: How Apple Glass will change the world...">

  <label>Short Preview (for the feed)</label>
  <input type="text" id="post-preview" placeholder="Brief description for the card">

  <label>Category</label>
  <select id="post-category">
    <option value="Programming">Programming</option>
    <option value="Gadgets">Gadgets</option>
    <option value="Design">Design</option>
    <option value="Other">Other</option>
  </select>

  <label>Content (Article text or YouTube link)</label>
  <textarea id="post-body" placeholder="Your article text or video link..."></textarea>

  <div id="media-section">
    <label>Upload Image or Video</label>
    <div class="file-input-wrapper" onclick="document.getElementById('media-file').click()">
      <div id="upload-text">Click to select a media file</div>
      <input type="file" id="media-file" accept="image/*,video/*" style="display: none;" onchange="previewMedia(event)">
      <img id="image-preview" alt="Preview">
    </div>
  </div>

  <label>Interest Tags</label>
  <div class="tag-group">
    <input type="checkbox" id="t1" class="tag-checkbox" value="programming"><label for="t1" class="tag-label">programming</label>
    <input type="checkbox" id="t2" class="tag-checkbox" value="design"><label for="t2" class="tag-label">design</label>
    <input type="checkbox" id="t3" class="tag-checkbox" value="gadgets"><label for="t3" class="tag-label">gadgets</label>
    <input type="checkbox" id="t4" class="tag-checkbox" value="mongodb"><label for="t4" class="tag-label">mongodb</label>
    <input type="checkbox" id="t5" class="tag-checkbox" value="node"><label for="t5" class="tag-label">node</label>
    <input type="checkbox" id="t6" class="tag-checkbox" value="future"><label for="t6" class="tag-label">future</label>
  </div>

  <button onclick="publish()" id="publish-btn" class="publish-btn">Publish to Feed</button>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const editPostId = urlParams.get('edit');

  async function checkEditMode() {
    if (editPostId) {
      document.getElementById('page-title').innerText = "Edit Innovation";
      document.getElementById('publish-btn').innerText = "Save Changes";
      document.getElementById('media-section').classList.add('hidden');

      try {
        const res = await fetch(`/api/content/single/${editPostId}`);
        const post = await res.json();

        if (res.ok) {
          document.getElementById('post-title').value = post.title;
          document.getElementById('post-preview').value = post.preview || '';
          document.getElementById('post-category').value = post.category;
          document.getElementById('post-body').value = post.body;

          if (post.tags) {
            post.tags.forEach(tag => {
              const checkbox = document.querySelector(`.tag-checkbox[value="${tag.toLowerCase()}"]`);
              if (checkbox) checkbox.checked = true;
            });
          }
        }
      } catch (e) {
        alert("Error loading post data");
      }
    }
  }

  function previewMedia(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('image-preview');
    const uploadText = document.getElementById('upload-text');

    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.src = e.target.result;
        preview.style.display = 'block';
        uploadText.innerText = `File selected: ${file.name}`;
      };
      reader.readAsDataURL(file);
    } else {
      preview.style.display = 'none';
      if(file) uploadText.innerText = `File selected: ${file.name}`;
    }
  }

  async function publish() {
    const title = document.getElementById('post-title').value.trim();
    const preview = document.getElementById('post-preview').value.trim();
    const body = document.getElementById('post-body').value.trim();
    const category = document.getElementById('post-category').value;
    const tags = Array.from(document.querySelectorAll('.tag-checkbox:checked')).map(cb => cb.value);

    const userData = localStorage.getItem('user');
    const user = userData ? JSON.parse(userData) : null;
    const authorId = user?._id || user?.id;

    if (!authorId) return alert("Please log in to the system");
    if (!title) return alert("Title is required!");

    const btn = document.getElementById('publish-btn');
    btn.disabled = true;
    btn.innerText = "Saving...";

    const method = editPostId ? 'PUT' : 'POST';
    const apiUrl = editPostId ? `/api/content/${editPostId}` : '/api/content';

    let requestBody;
    let headers = { 'x-author-id': authorId };

    if (!editPostId) {
      const formData = new FormData();
      formData.append('title', title);
      formData.append('preview', preview);
      formData.append('body', body);
      formData.append('category', category);
      formData.append('tags', JSON.stringify(tags));

      let type = 'post';
      if (body.includes('youtube.com') || body.includes('youtu.be')) type = 'video';
      formData.append('type', type);

      const mediaFile = document.getElementById('media-file').files[0];
      if (mediaFile) formData.append('mediaFile', mediaFile);

      requestBody = formData;
    } else {
      headers['Content-Type'] = 'application/json';
      requestBody = JSON.stringify({
        title,
        preview,
        body,
        category,
        tags: JSON.stringify(tags)
      });
    }

    try {
      const res = await fetch(apiUrl, {
        method: method,
        headers: headers,
        body: requestBody
      });

      const data = await res.json();

      if (res.ok) {
        alert(editPostId ? "Innovation updated!" : "Innovation published!");
        window.location.href = '/profile.html';
      } else {
        alert("Error: " + (data.error || "Failed to save"));
      }
    } catch (e) {
      console.error(e);
      alert("Network error. Please check your server connection.");
    } finally {
      btn.disabled = false;
      btn.innerText = editPostId ? "Save Changes" : "Publish to Feed";
    }
  }

  checkEditMode();
</script>
</body>
</html>