<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–æ–∑–¥–∞—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é</title>
  <style>
    :root { --primary: #0071e3; --bg: #f5f5f7; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
    .editor-container { max-width: 700px; margin: 40px auto; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .back-link { text-decoration: none; color: var(--primary); font-weight: 500; display: inline-block; margin-bottom: 20px; }

    label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 14px; color: #333; }
    input, textarea, select {
      width: 100%; padding: 12px; margin-bottom: 20px;
      border: 1px solid #ddd; border-radius: 10px;
      font-size: 16px; box-sizing: border-box; font-family: inherit;
    }
    textarea { height: 80px; resize: none; }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—è —Ñ–∞–π–ª–∞ */
    .file-input-wrapper {
      border: 2px dashed #ddd; padding: 20px; text-align: center;
      border-radius: 12px; margin-bottom: 20px; cursor: pointer; transition: 0.2s;
    }
    .file-input-wrapper:hover { border-color: var(--primary); background: #fbfdff; }

    .tag-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
    .tag-checkbox { display: none; }
    .tag-label { padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; font-size: 13px; transition: 0.2s; background: #fff; }
    .tag-checkbox:checked + .tag-label { background: var(--primary); color: white; border-color: var(--primary); }

    .publish-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 18px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; }
    .publish-btn:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>

<div class="editor-container">
  <a href="/" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  <h1>–ù–æ–≤–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è üöÄ</h1>

  <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ (title)</label>
  <input type="text" id="post-title" placeholder="–ù–∞–ø—Ä: –ú–æ–π –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç">

  <label>–ö—Ä–∞—Ç–∫–æ–µ –ø—Ä–µ–≤—å—é (preview)</label>
  <input type="text" id="post-preview" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏">

  <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è (category)</label>
  <select id="post-category">
    <option value="Programming">Programming</option>
    <option value="Gadgets">Gadgets</option>
    <option value="Design">Design</option>
    <option value="Other">Other</option>
  </select>

  <label>–°—Å—ã–ª–∫–∞ –∏–ª–∏ —Ç–µ–∫—Å—Ç (body)</label>
  <textarea id="post-body" placeholder="URL –≤–∏–¥–µ–æ —Å YouTube –∏–ª–∏ —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏..."></textarea>

  <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∏–∞ (—Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ)</label>
  <div class="file-input-wrapper">
    <input type="file" id="media-file" accept="image/*,video/*">
  </div>

  <label>–¢–µ–≥–∏ (tags)</label>
  <div class="tag-group">
    <input type="checkbox" id="t1" class="tag-checkbox" value="mongodb"><label for="t1" class="tag-label">mongodb</label>
    <input type="checkbox" id="t2" class="tag-checkbox" value="javascript"><label for="t2" class="tag-label">javascript</label>
    <input type="checkbox" id="t3" class="tag-checkbox" value="node"><label for="t3" class="tag-label">node</label>
    <input type="checkbox" id="t4" class="tag-checkbox" value="apple"><label for="t4" class="tag-label">apple</label>
    <input type="checkbox" id="t5" class="tag-checkbox" value="iphone"><label for="t5" class="tag-label">iphone</label>
    <input type="checkbox" id="t6" class="tag-checkbox" value="tech"><label for="t6" class="tag-label">tech</label>
  </div>

  <button onclick="publish()" id="publish-btn" class="publish-btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</div>

<script>
  async function publish() {
    const title = document.getElementById('post-title').value.trim();
    const preview = document.getElementById('post-preview').value.trim();
    const body = document.getElementById('post-body').value.trim();
    const category = document.getElementById('post-category').value;
    const tags = Array.from(document.querySelectorAll('.tag-checkbox:checked')).map(cb => cb.value);
    const mediaFile = document.getElementById('media-file').files[0];

    const userData = localStorage.getItem('user');
    if (!userData) return alert("–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É");
    const user = JSON.parse(userData);

    // –í–∞–ª–∏–¥–∞—Ü–∏—è: –Ω—É–∂–µ–Ω –ª–∏–±–æ —Ç–µ–∫—Å—Ç/—Å—Å—ã–ª–∫–∞, –ª–∏–±–æ —Ñ–∞–π–ª
    if(!title) return alert("–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
    if(!body && !mediaFile) return alert("–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª");

    const btn = document.getElementById('publish-btn');
    btn.disabled = true;
    btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";

    // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–æ–≤
    const formData = new FormData();
    formData.append('title', title);
    formData.append('preview', preview);
    formData.append('body', body);
    formData.append('category', category);
    formData.append('tags', tags.join(',')); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ –∫–∞–∫ —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
    formData.append('userId', user.id || user._id);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π —Ç–∏–ø (—Å–µ—Ä–≤–µ—Ä –µ–≥–æ —É—Ç–æ—á–Ω–∏—Ç –ø–æ —Ñ–∞–π–ª—É)
    formData.append('type', (body.includes('youtube') || body.includes('youtu.be')) ? 'video' : 'post');

    if (mediaFile) {
      formData.append('mediaFile', mediaFile);
    }

    try {
      const res = await fetch('/api/content', {
        method: 'POST',
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ Content-Type –ù–ï —Å—Ç–∞–≤–∏–º, –±—Ä–∞—É–∑–µ—Ä —Å–∞–º –ø–æ—Å—Ç–∞–≤–∏—Ç multipart/form-data
        body: formData
      });

      if (res.ok) {
        alert("–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!");
        window.location.href = '/';
      } else {
        const err = await res.json();
        alert("–û—à–∏–±–∫–∞: " + err.error);
      }
    } catch (e) {
      alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
    } finally {
      btn.disabled = false;
      btn.innerText = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å";
    }
  }
</script>
</body>
</html>