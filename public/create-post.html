<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–æ–∑–¥–∞—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é | TechPlatform</title>
  <style>
    :root { --primary: #0071e3; --bg: #f5f5f7; --border: #d2d2d7; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1d1d1f; }
    .editor-container { max-width: 700px; margin: 40px auto; background: white; padding: 40px; border-radius: 28px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
    .back-link { text-decoration: none; color: var(--primary); font-weight: 600; display: inline-block; margin-bottom: 25px; font-size: 15px; }
    h1 { font-size: 32px; letter-spacing: -0.8px; margin-bottom: 30px; }
    label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #1d1d1f; }
    input, textarea, select {
      width: 100%; padding: 14px; margin-bottom: 20px;
      border: 1px solid var(--border); border-radius: 12px;
      font-size: 16px; box-sizing: border-box; font-family: inherit; outline: none;
      transition: 0.2s; background: #fafafa;
    }
    input:focus, textarea:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px rgba(0,113,227,0.1); }
    textarea { height: 120px; resize: none; }
    .file-input-wrapper {
      border: 2px dashed var(--border); padding: 30px; text-align: center;
      border-radius: 16px; margin-bottom: 20px; cursor: pointer; transition: 0.2s;
      position: relative; background: #fafafa;
    }
    .file-input-wrapper:hover { border-color: var(--primary); background: #fff; }
    #image-preview { width: 100%; max-height: 300px; object-fit: cover; border-radius: 12px; display: none; margin-top: 15px; }
    .tag-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
    .tag-checkbox { display: none; }
    .tag-label {
      padding: 10px 20px; border: 1px solid var(--border); border-radius: 20px;
      cursor: pointer; font-size: 13px; transition: 0.2s; background: #fff; font-weight: 500;
    }
    .tag-checkbox:checked + .tag-label { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,113,227,0.2); }
    .publish-btn {
      width: 100%; background: var(--primary); color: white; border: none;
      padding: 18px; border-radius: 14px; font-size: 18px; font-weight: 700;
      cursor: pointer; transition: 0.3s;
    }
    .publish-btn:hover { background: #0077ed; transform: translateY(-2px); }
    .publish-btn:disabled { background: #d2d2d7; cursor: not-allowed; transform: none; }
  </style>
</head>
<body>

<div class="editor-container">
  <a href="/" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  <h1>–°–æ–∑–¥–∞—Ç—å –∏–Ω–Ω–æ–≤–∞—Ü–∏—é üöÄ</h1>

  <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
  <input type="text" id="post-title" placeholder="–ù–∞–ø—Ä: –ö–∞–∫ Apple Glass –∏–∑–º–µ–Ω—è—Ç –º–∏—Ä...">

  <label>–ö—Ä–∞—Ç–∫–æ–µ –ø—Ä–µ–≤—å—é (–¥–ª—è –ª–µ–Ω—Ç—ã)</label>
  <input type="text" id="post-preview" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏">

  <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
  <select id="post-category">
    <option value="Programming">Programming</option>
    <option value="Gadgets">Gadgets</option>
    <option value="Design">Design</option>
    <option value="Other">Other</option>
  </select>

  <label>–ö–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏ –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ YouTube)</label>
  <textarea id="post-body" placeholder="–¢–µ–∫—Å—Ç –≤–∞—à–µ–π —Å—Ç–∞—Ç—å–∏ –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ..."></textarea>

  <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –≤–∏–¥–µ–æ</label>
  <div class="file-input-wrapper" onclick="document.getElementById('media-file').click()">
    <div id="upload-text">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –º–µ–¥–∏–∞—Ñ–∞–π–ª</div>
    <input type="file" id="media-file" accept="image/*,video/*" style="display: none;" onchange="previewMedia(event)">
    <img id="image-preview" alt="–ü—Ä–µ–≤—å—é">
  </div>

  <label>–¢–µ–≥–∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ üéØ</label>
  <div class="tag-group">
    <input type="checkbox" id="t1" class="tag-checkbox" value="programming"><label for="t1" class="tag-label">üíª programming</label>
    <input type="checkbox" id="t2" class="tag-checkbox" value="design"><label for="t2" class="tag-label">üé® design</label>
    <input type="checkbox" id="t3" class="tag-checkbox" value="gadgets"><label for="t3" class="tag-label">üì± gadgets</label>
    <input type="checkbox" id="t4" class="tag-checkbox" value="mongodb"><label for="t4" class="tag-label">üíæ mongodb</label>
    <input type="checkbox" id="t5" class="tag-checkbox" value="node"><label for="t5" class="tag-label">‚öôÔ∏è node</label>
    <input type="checkbox" id="t6" class="tag-checkbox" value="future"><label for="t6" class="tag-label">üöÄ future</label>
  </div>

  <button onclick="publish()" id="publish-btn" class="publish-btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –ª–µ–Ω—Ç—É</button>
</div>

<script>
  function previewMedia(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('image-preview');
    const uploadText = document.getElementById('upload-text');

    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.src = e.target.result;
        preview.style.display = 'block';
        uploadText.innerText = `–§–∞–π–ª –≤—ã–±—Ä–∞–Ω: ${file.name}`;
      };
      reader.readAsDataURL(file);
    } else {
      preview.style.display = 'none';
      if(file) uploadText.innerText = `–§–∞–π–ª –≤—ã–±—Ä–∞–Ω: ${file.name}`;
    }
  }

  async function publish() {
    const title = document.getElementById('post-title').value.trim();
    const preview = document.getElementById('post-preview').value.trim();
    const body = document.getElementById('post-body').value.trim();
    const category = document.getElementById('post-category').value;
    const tags = Array.from(document.querySelectorAll('.tag-checkbox:checked')).map(cb => cb.value);
    const mediaFile = document.getElementById('media-file').files[0];

    const userData = localStorage.getItem('user');
    if (!userData) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É");
      window.location.href = '/login.html';
      return;
    }

    const user = JSON.parse(userData);
    const authorId = user.id || user._id;

    if (!authorId) return alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–≤–æ–π–¥–∏—Ç–µ.");
    if (!title) return alert("–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!");

    const btn = document.getElementById('publish-btn');
    btn.disabled = true;
    btn.innerText = "–ü—É–±–ª–∏–∫—É–µ–º...";

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º FormData –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Multer –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
    const formData = new FormData();
    formData.append('title', title);
    formData.append('preview', preview);
    formData.append('body', body);
    formData.append('category', category);
    formData.append('tags', JSON.stringify(tags));

    // –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –ª–æ–≥–∏–∫–∏ –±—ç–∫–µ–Ω–¥–∞
    let type = 'post';
    if (body.includes('youtube.com') || body.includes('youtu.be')) type = 'video';
    formData.append('type', type);

    if (mediaFile) {
      formData.append('mediaFile', mediaFile);
    }

    try {
      const res = await fetch('/api/content', {
        method: 'POST',
        headers: {
          // –í–û–¢ –û–ù: –¢–æ—Ç —Å–∞–º—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –∂–¥–µ—Ç —Ç–≤–æ–π server.js
          'x-author-id': authorId
        },
        // –í–∞–∂–Ω–æ: –¥–ª—è FormData –∑–∞–≥–æ–ª–æ–≤–∫–∏ Content-Type —Å—Ç–∞–≤–∏—Ç—å –ù–ï–õ–¨–ó–Ø!
        body: formData
      });

      const data = await res.json();

      if (res.ok) {
        alert("–ò–Ω–Ω–æ–≤–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞! üöÄ");
        window.location.href = '/';
      } else {
        alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + (data.error || "–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"));
      }
    } catch (e) {
      console.error(e);
      alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.");
    } finally {
      btn.disabled = false;
      btn.innerText = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –ª–µ–Ω—Ç—É";
    }
  }
</script>
</body>
</html>