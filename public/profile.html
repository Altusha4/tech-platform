<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å | TechPlatform</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <style>
    :root { --primary: #0071e3; --bg: #f5f5f7; --red: #ff3b30; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
    .profile-card { background: white; max-width: 850px; margin: 20px auto; padding: 35px; border-radius: 28px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }

    /* –®–∞–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è */
    .profile-header { display: flex; align-items: center; gap: 25px; margin-bottom: 35px; }
    .avatar-container { position: relative; width: 110px; height: 110px; cursor: pointer; }
    .avatar { width: 100%; height: 100%; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 45px; overflow: hidden; border: 4px solid #fff; box-shadow: 0 0 15px rgba(0,0,0,0.1); transition: 0.3s; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-edit-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600; opacity: 0; transition: 0.3s; }
    .avatar-container:hover .avatar-edit-overlay { opacity: 1; }

    /* –í–∫–ª–∞–¥–∫–∏ */
    .tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 30px; gap: 30px; overflow-x: auto; }
    .tab-btn { padding: 12px 0; border: none; background: none; cursor: pointer; font-size: 16px; color: #888; border-bottom: 3px solid transparent; transition: 0.3s; white-space: nowrap; }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }

    /* –°–µ—Ç–∫–∞ –ø–æ—Å—Ç–æ–≤ */
    .posts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
    .post-item { background: #fff; border: 1px solid #f0f0f0; border-radius: 18px; overflow: hidden; transition: 0.3s; display: flex; flex-direction: column; }
    .post-item:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
    .post-preview { width: 100%; height: 150px; background: #1a1a1a; overflow: hidden; position: relative; cursor: pointer; }
    .post-preview img, .post-preview video { width: 100%; height: 100%; object-fit: cover; }
    .post-content { padding: 18px; flex-grow: 1; display: flex; flex-direction: column; }
    .post-title { font-size: 15px; font-weight: 600; margin: 0 0 12px 0; height: 42px; overflow: hidden; line-height: 1.4; cursor: pointer; }
    .post-title:hover { color: var(--primary); }

    .post-stats { display: flex; gap: 12px; font-size: 13px; color: #999; margin-bottom: 15px; }
    .post-actions { display: flex; gap: 10px; margin-top: auto; }
    .btn-action { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #eee; cursor: pointer; font-size: 13px; background: #fff; transition: 0.2s; }
    .btn-delete:hover { background: var(--red); color: white; border-color: var(--red); }
    .btn-edit-post:hover { background: var(--primary); color: white; border-color: var(--primary); }

    /* –ò–Ω—Ç–µ—Ä–µ—Å—ã */
    .interests-container { background: #f9f9fb; padding: 30px; border-radius: 20px; border: 1px solid #f0f0f5; }
    .interests-grid { display: flex; flex-wrap: wrap; gap: 12px; margin: 25px 0; }
    .interest-item { cursor: pointer; }
    .interest-item input { display: none; }
    .interest-item .tag-box { display: inline-block; padding: 10px 22px; border-radius: 25px; background: #fff; border: 2px solid #eee; color: #666; font-weight: 500; transition: 0.2s; user-select: none; }
    .interest-item input:checked + .tag-box { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }
    .btn-save-interests { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 14px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-content input, .modal-content textarea, .modal-content select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-family: inherit; }
    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }

    .hidden { display: none; }
    .upload-section { margin-bottom: 25px; padding: 20px; border: 2px dashed #eee; border-radius: 15px; text-align: center; }
    .cropper-wrapper { max-height: 350px; border-radius: 12px; overflow: hidden; margin-top: 20px; }
  </style>
</head>
<body>

<div class="profile-card">
  <div id="view-mode">
    <div class="profile-header">
      <div class="avatar-container" onclick="toggleMode()">
        <div class="avatar" id="avatar-circle">?</div>
        <div class="avatar-edit-overlay">–ò–ó–ú–ï–ù–ò–¢–¨</div>
      </div>
      <div>
        <h2 id="display-name" style="margin: 0; font-size: 26px;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <p id="display-email" style="color: #666; margin: 5px 0 0 0;"></p>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" id="tab-posts" onclick="switchTab('posts')">–ú–æ–∏ –ø–æ—Å—Ç—ã <span id="post-count"></span></button>
      <button class="tab-btn" id="tab-bookmarks" onclick="switchTab('bookmarks')">–ó–∞–∫–ª–∞–¥–∫–∏ üîñ</button>
      <button class="tab-btn" id="tab-liked" onclick="switchTab('liked')">–ü–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å</button>
      <button class="tab-btn" id="tab-interests" onclick="switchTab('interests')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div id="content-posts">
      <div id="my-posts-list" class="posts-grid"></div>
    </div>

    <div id="content-bookmarks" class="hidden">
      <div id="bookmarks-list" class="posts-grid"></div>
    </div>

    <div id="content-liked" class="hidden">
      <div id="liked-posts-list" class="posts-grid"></div>
    </div>

    <div id="content-interests" class="hidden">
      <div class="interests-container">
        <h3 style="margin-top:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–µ–Ω—Ç—ã üéØ</h3>
        <div class="interests-grid">
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="ai"><span class="tag-box">#ai</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="javascript"><span class="tag-box">#javascript</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="mongodb"><span class="tag-box">#mongodb</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="design"><span class="tag-box">#design</span></label>
        </div>
        <button onclick="updateInterests()" id="interest-save-btn" class="btn-save-interests">–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—ã</button>
      </div>
    </div>
    <a href="/" style="display: block; margin-top: 35px; color: var(--primary); text-decoration: none; font-size: 15px;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
  </div>

  <div id="edit-mode" class="hidden">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h3>
    <div class="upload-section">
      <input type="file" id="avatar-input" accept="image/*" onchange="initCropper(event)">
      <div id="cropper-container" class="hidden">
        <div class="cropper-wrapper"><img id="cropper-image" src=""></div>
        <button type="button" onclick="applyCrop()" style="background:var(--primary); color:#fff; border:none; padding:12px 20px; border-radius:10px; margin-top:15px; cursor:pointer;">–û–±—Ä–µ–∑–∞—Ç—å —Ñ–æ—Ç–æ</button>
      </div>
    </div>
    <div style="display: flex; gap: 12px;">
      <button onclick="saveAvatarOnly()" id="save-avatar-btn" style="background:#28a745; color:#fff; border:none; padding:15px 25px; border-radius:12px; cursor:pointer; flex:2; font-weight: bold;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
      <button onclick="toggleMode()" style="background:#eee; border:none; padding:15px 25px; border-radius:12px; cursor:pointer; flex:1;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<div id="edit-post-modal" class="modal">
  <div class="modal-content">
    <h3 style="margin-top:0">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç</h3>
    <input type="hidden" id="edit-post-id">
    <label style="font-size:12px; color:#666;">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
    <input type="text" id="edit-post-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
    <label style="font-size:12px; color:#666;">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
    <input type="text" id="edit-post-preview" placeholder="–ü—Ä–µ–≤—å—é">
    <label style="font-size:12px; color:#666;">–ö–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–∫—Å—Ç –∏–ª–∏ YouTube URL)</label>
    <textarea id="edit-post-body" style="height: 100px;" placeholder="–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞..."></textarea>
    <label style="font-size:12px; color:#666;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
    <select id="edit-post-category">
      <option value="Programming">Programming</option>
      <option value="Gadgets">Gadgets</option>
      <option value="Design">Design</option>
      <option value="Other">Other</option>
    </select>
    <div class="modal-actions">
      <button onclick="savePostEdit()" id="btn-save-post" style="flex:2; padding:12px; border:none; border-radius:10px; background:var(--primary); color:white; cursor:pointer; font-weight:bold;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="closeEditModal()" style="flex:1; padding:12px; border:none; border-radius:10px; background:#eee; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script>
  let currentUser = JSON.parse(localStorage.getItem('user'));
  let cropper;
  let croppedBlob;

  function getYouTubeID(url) {
    if (!url) return null;
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  }

  function init() {
    if (!currentUser) { window.location.href = '/login.html'; return; }
    renderData();
    loadMyPosts();
  }

  function renderData() {
    const avatarCircle = document.getElementById('avatar-circle');
    if (currentUser.avatarUrl) {
      avatarCircle.innerHTML = `<img src="${currentUser.avatarUrl}" style="width:100%; height:100%; object-fit:cover;">`;
    } else {
      avatarCircle.innerHTML = currentUser.username ? currentUser.username[0].toUpperCase() : '?';
    }
    document.getElementById('display-name').innerText = currentUser.username || '–ó–∞–≥—Ä—É–∑–∫–∞...';
    document.getElementById('display-email').innerText = currentUser.email || '';
    document.querySelectorAll('input[name="profile-interest"]').forEach(cb => {
      cb.checked = currentUser.interests && currentUser.interests.includes(cb.value);
    });
  }

  function switchTab(tab) {
    ['posts', 'bookmarks', 'liked', 'interests'].forEach(t => {
      document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
      document.getElementById(`content-${t}`).classList.toggle('hidden', t !== tab);
    });
    if(tab === 'posts') loadMyPosts();
    if(tab === 'bookmarks') loadBookmarks();
    if(tab === 'liked') loadLikedPosts();
  }

  async function loadMyPosts() {
    const list = document.getElementById('my-posts-list');
    const countSpan = document.getElementById('post-count');
    try {
      const res = await fetch(`/api/content/user/${currentUser.id || currentUser._id}`);
      const posts = await res.json();
      countSpan.innerText = posts.length > 0 ? `(${posts.length})` : '';
      list.innerHTML = posts.length ? posts.map(p => renderPostCard(p, true)).join('') : "<p style='grid-column:1/-1; text-align:center; color:#999;'>–ü—É—Å—Ç–æ</p>";
    } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"; }
  }

  async function loadBookmarks() {
    const list = document.getElementById('bookmarks-list');
    const bookmarkIds = JSON.parse(localStorage.getItem('bookmarks') || '[]');
    if (bookmarkIds.length === 0) {
      list.innerHTML = "<p style='grid-column:1/-1; text-align:center; color:#999;'>–£ –≤–∞—Å –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–ª–∞–¥–æ–∫ üìë</p>";
      return;
    }
    list.innerHTML = "<p style='grid-column:1/-1; text-align:center;'>–ó–∞–≥—Ä—É–∑–∫–∞...</p>";
    try {
      const promises = bookmarkIds.map(id => fetch(`/api/content/single/${id}`).then(r => r.json()));
      const posts = await Promise.all(promises);
      list.innerHTML = posts.map(p => renderPostCard(p, false)).join('');
    } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–ª–∞–¥–æ–∫"; }
  }

  async function loadLikedPosts() {
    const list = document.getElementById('liked-posts-list');
    try {
      const res = await fetch(`/api/content/liked/${currentUser.id || currentUser._id}`);
      const posts = await res.json();
      list.innerHTML = posts.length ? posts.map(p => renderPostCard(p, false)).join('') : "<p style='grid-column:1/-1; text-align:center; color:#999;'>–ù–µ—Ç –ª–∞–π–∫–æ–≤</p>";
    } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞"; }
  }

  function renderPostCard(post, isOwner) {
    const ytId = getYouTubeID(post.body);
    const ytPreview = ytId ? `https://img.youtube.com/vi/${ytId}/mqdefault.jpg` : null;
    return `
      <div class="post-item" id="post-${post._id}">
        <div class="post-preview" onclick="window.location.href='/post.html?id=${post._id}'">
          ${post.mediaUrl
            ? (post.type === 'video' ? `<video src="${post.mediaUrl}"></video>` : `<img src="${post.mediaUrl}">`)
            : (ytPreview ? `<img src="${ytPreview}" alt="YouTube">` : `<div style="padding:20px; color:#fff; font-size:12px; text-align:center; height:100%; display:flex; align-items:center;">${post.title}</div>`)
    }
        </div>
        <div class="post-content">
          <div class="post-title" onclick="window.location.href='/post.html?id=${post._id}'">${post.title}</div>
          <div class="post-stats"><span>‚ù§Ô∏è ${post.likes || 0}</span> <span>üí¨ ${post.stats?.commentsCount || 0}</span></div>
          ${isOwner ? `
            <div class="post-actions">
              <button class="btn-action btn-edit-post" onclick="openEditModal('${post._id}')">‚öôÔ∏è</button>
              <button class="btn-action btn-delete" onclick="deletePost('${post._id}')">üóëÔ∏è</button>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  async function openEditModal(postId) {
    const res = await fetch(`/api/content/single/${postId}`);
    const post = await res.json();
    document.getElementById('edit-post-id').value = post._id;
    document.getElementById('edit-post-title').value = post.title;
    document.getElementById('edit-post-preview').value = post.preview || '';
    document.getElementById('edit-post-body').value = post.body || '';
    document.getElementById('edit-post-category').value = post.category || 'Other';
    document.getElementById('edit-post-modal').style.display = 'flex';
  }

  function closeEditModal() { document.getElementById('edit-post-modal').style.display = 'none'; }

  async function savePostEdit() {
    const id = document.getElementById('edit-post-id').value;
    const btn = document.getElementById('btn-save-post');
    const data = {
      title: document.getElementById('edit-post-title').value,
      preview: document.getElementById('edit-post-preview').value,
      body: document.getElementById('edit-post-body').value,
      category: document.getElementById('edit-post-category').value
    };
    btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
    btn.disabled = true;
    const res = await fetch(`/api/content/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if(res.ok) {
      closeEditModal();
      await loadMyPosts();
    }
    btn.innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
    btn.disabled = false;
  }

  async function updateInterests() {
    const btn = document.getElementById('interest-save-btn');
    const selected = Array.from(document.querySelectorAll('input[name="profile-interest"]:checked')).map(cb => cb.value);
    btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
    const res = await fetch('/api/users/update', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: currentUser.id || currentUser._id, interests: selected })
    });
    if(res.ok) {
      const data = await res.json();
      const updatedUser = { ...currentUser, interests: data.user.interests };
      localStorage.setItem('user', JSON.stringify(updatedUser));
      currentUser = updatedUser;
      alert("–ò–Ω—Ç–µ—Ä–µ—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã!");
      renderData();
    }
    btn.innerText = "–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—ã";
  }

  async function deletePost(postId) {
    if(!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
    const res = await fetch(`/api/content/${postId}`, { method: 'DELETE' });
    if(res.ok) loadMyPosts();
  }

  function toggleMode() {
    document.getElementById('view-mode').classList.toggle('hidden');
    document.getElementById('edit-mode').classList.toggle('hidden');
  }

  function initCropper(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = document.getElementById('cropper-image');
      img.src = e.target.result;
      document.getElementById('cropper-container').classList.remove('hidden');
      if (cropper) cropper.destroy();
      cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 });
    };
    reader.readAsDataURL(file);
  }

  function applyCrop() {
    cropper.getCroppedCanvas({ width: 400, height: 400 }).toBlob(blob => {
      croppedBlob = blob;
      alert("–§–æ—Ç–æ –æ–±—Ä–µ–∑–∞–Ω–æ!");
      document.getElementById('cropper-container').classList.add('hidden');
    }, 'image/jpeg');
  }

  async function saveAvatarOnly() {
    if(!croppedBlob) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏ –æ–±—Ä–µ–∂—å—Ç–µ —Ñ–æ—Ç–æ");
    const fd = new FormData();
    fd.append('avatar', croppedBlob);
    fd.append('userId', currentUser.id || currentUser._id);
    const btn = document.getElementById('save-avatar-btn');
    btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    btn.disabled = true;
    try {
      const res = await fetch('/api/users/upload-avatar', { method: 'POST', body: fd });
      if(res.ok) {
        const data = await res.json();
        const updatedUser = { ...currentUser, avatarUrl: data.user.avatarUrl };
        localStorage.setItem('user', JSON.stringify(updatedUser));
        currentUser = updatedUser;
        location.reload();
      }
    } catch (e) {
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ");
    } finally {
      btn.innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ";
      btn.disabled = false;
    }
  }

  init();
</script>
</body>
</html>