<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Мой профиль</title>
  <style>
    body { font-family: -apple-system, sans-serif; background: #f5f5f7; margin: 0; padding: 20px; }
    .profile-card { background: white; max-width: 500px; margin: 50px auto; padding: 30px; border-radius: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .avatar { width: 80px; height: 80px; background: #0071e3; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; margin-bottom: 20px; }
    .interest-tag { display: inline-block; background: #e8f2ff; color: #0071e3; padding: 5px 12px; border-radius: 15px; font-size: 13px; margin: 5px 5px 5px 0; font-weight: 500; }
    .btn-edit { background: #0071e3; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 20px; }
    .btn-save { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
    .hidden { display: none; }
    .edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
  </style>
</head>
<body>

<div class="profile-card">
  <div id="view-mode">
    <div class="avatar" id="avatar-circle">?</div>
    <h2 id="display-name">Загрузка...</h2>
    <p id="display-email" style="color: #666;"></p>

    <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
      <strong>Мои интересы:</strong>
      <div id="interests-list" style="margin-top: 10px;"></div>
    </div>

    <button class="btn-edit" onclick="toggleMode()">Редактировать интересы</button>
    <br>
    <a href="/" style="display: block; margin-top: 20px; color: #0071e3; text-decoration: none; font-size: 14px;">← На главную</a>
  </div>

  <div id="edit-mode" class="hidden">
    <h3>Редактировать интересы</h3>
    <div class="edit-grid">
      <label><input type="checkbox" name="edit-interest" value="AI"> AI & ML</label>
      <label><input type="checkbox" name="edit-interest" value="Web"> Web Dev</label>
      <label><input type="checkbox" name="edit-interest" value="Mobile"> Mobile</label>
      <label><input type="checkbox" name="edit-interest" value="Design"> UI/UX</label>
      <label><input type="checkbox" name="edit-interest" value="Data"> Data Science</label>
      <label><input type="checkbox" name="edit-interest" value="Cloud"> Cloud</label>
    </div>
    <div style="margin-top: 25px; display: flex; gap: 10px;">
      <button class="btn-save" onclick="saveChanges()">Сохранить</button>
      <button onclick="toggleMode()" style="background: #eee; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Отмена</button>
    </div>
  </div>
</div>

<script>
  let currentUser = JSON.parse(localStorage.getItem('user'));

  function init() {
    if (!currentUser) {
      window.location.href = '/login.html';
      return;
    }
    renderData();
  }

  function renderData() {
    document.getElementById('avatar-circle').innerText = currentUser.username[0].toUpperCase();
    document.getElementById('display-name').innerText = currentUser.username;
    document.getElementById('display-email').innerText = currentUser.email;

    const list = document.getElementById('interests-list');
    list.innerHTML = currentUser.interests.length > 0
            ? currentUser.interests.map(i => `<span class="interest-tag">#${i}</span>`).join('')
            : 'Не выбрано';

    const checkboxes = document.querySelectorAll('input[name="edit-interest"]');
    checkboxes.forEach(cb => {
      cb.checked = currentUser.interests.includes(cb.value);
    });
  }

  function toggleMode() {
    document.getElementById('view-mode').classList.toggle('hidden');
    document.getElementById('edit-mode').classList.toggle('hidden');
  }

  async function saveChanges() {
    const selected = Array.from(document.querySelectorAll('input[name="edit-interest"]:checked'))
            .map(cb => cb.value);

    const res = await fetch('/api/users/update', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id || currentUser._id,
        interests: selected
      })
    });

    if (res.ok) {
      const data = await res.json();
      localStorage.setItem('user', JSON.stringify(data.user));
      currentUser = data.user;
      renderData();
      toggleMode();
      alert("Профиль успешно обновлен!");
    } else {
      alert("Ошибка при сохранении");
    }
  }

  init();
</script>
</body>
</html>