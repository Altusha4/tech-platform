<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å | TechPlatform</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <style>
    :root { --primary: #0071e3; --bg: #f5f5f7; --red: #ff3b30; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1d1d1f; }
    .profile-card { background: white; max-width: 850px; margin: 20px auto; padding: 35px; border-radius: 28px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); }

    .profile-header { display: flex; align-items: center; gap: 25px; margin-bottom: 35px; }
    .avatar-container { position: relative; width: 110px; height: 110px; cursor: pointer; }
    .avatar { width: 100%; height: 100%; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 45px; overflow: hidden; border: 4px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-edit-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 700; opacity: 0; transition: 0.3s; }
    .avatar-container:hover .avatar-edit-overlay { opacity: 1; }

    .tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 30px; gap: 25px; overflow-x: auto; scrollbar-width: none; }
    .tab-btn { padding: 12px 0; border: none; background: none; cursor: pointer; font-size: 15px; color: #86868b; border-bottom: 3px solid transparent; transition: 0.2s; font-weight: 500; white-space: nowrap; }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 700; }

    .posts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
    .post-item { background: #fff; border: 1px solid #f0f0f0; border-radius: 18px; overflow: hidden; transition: 0.3s; display: flex; flex-direction: column; position: relative; }
    .post-item:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); }

    .post-preview { width: 100%; height: 150px; background: #000; overflow: hidden; position: relative; cursor: pointer; }
    .post-preview img { width: 100%; height: 100%; object-fit: cover; }
    .post-content { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
    .post-title { font-size: 15px; font-weight: 600; margin-bottom: 8px; line-height: 1.4; height: 42px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; cursor: pointer; }

    .post-actions { margin-top: auto; padding-top: 10px; display: flex; justify-content: space-between; align-items: center; }
    .btn-delete-post { background: none; border: none; color: var(--red); font-size: 13px; font-weight: 600; cursor: pointer; padding: 5px 10px; border-radius: 8px; transition: 0.2s; }
    .btn-delete-post:hover { background: rgba(255, 59, 48, 0.1); }

    .interests-container { background: #fafafa; padding: 25px; border-radius: 20px; border: 1px solid #eee; }
    .interests-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin: 20px 0; }
    .interest-item { cursor: pointer; }
    .interest-item input { display: none; }
    .interest-item .tag-box {
      display: block; text-align: center; padding: 12px; border-radius: 12px;
      background: #fff; border: 1px solid #d2d2d7; color: #1d1d1f;
      font-size: 14px; font-weight: 500; transition: 0.2s;
    }
    .interest-item input:checked + .tag-box {
      background: var(--primary); color: white; border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(0, 113, 227, 0.2);
    }

    .btn-save-interests { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 14px; cursor: pointer; font-weight: 700; font-size: 16px; }

    .hidden { display: none; }
    .upload-section { margin-bottom: 25px; padding: 30px; border: 2px dashed #d2d2d7; border-radius: 20px; text-align: center; }
  </style>
</head>
<body>

<div class="profile-card">
  <div id="view-mode">
    <div class="profile-header">
      <div class="avatar-container" onclick="toggleMode()">
        <div class="avatar" id="avatar-circle"></div>
        <div class="avatar-edit-overlay">–ò–ó–ú–ï–ù–ò–¢–¨</div>
      </div>
      <div>
        <h2 id="display-name">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <p id="display-email" style="color: #86868b;"></p>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" id="tab-posts" onclick="switchTab('posts')">–ú–æ–∏ –ø–æ—Å—Ç—ã <span id="post-count"></span></button>
      <button class="tab-btn" id="tab-bookmarks" onclick="switchTab('bookmarks')">–ó–∞–∫–ª–∞–¥–∫–∏ üîñ</button>
      <button class="tab-btn" id="tab-liked" onclick="switchTab('liked')">–ü–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å ‚ù§Ô∏è</button>
      <button class="tab-btn" id="tab-interests" onclick="switchTab('interests')">–ò–Ω—Ç–µ—Ä–µ—Å—ã üéØ</button>
    </div>

    <div id="content-posts">
      <div id="my-posts-list" class="posts-grid"></div>
    </div>

    <div id="content-bookmarks" class="hidden">
      <div id="bookmarks-list" class="posts-grid"></div>
    </div>

    <div id="content-liked" class="hidden">
      <div id="liked-posts-list" class="posts-grid"></div>
    </div>

    <div id="content-interests" class="hidden">
      <div class="interests-container">
        <h3 style="margin-top:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∞—à–µ–π –ª–µ–Ω—Ç—ã</h3>
        <p style="color: #86868b; font-size: 14px; margin-bottom: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—ã –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.</p>
        <div class="interests-grid">
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="Programming"><span class="tag-box">üíª Programming</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="Design"><span class="tag-box">üé® Design & UX</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="Gadgets"><span class="tag-box">üì± Gadgets</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="MongoDB"><span class="tag-box">üíæ MongoDB</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="Node.js"><span class="tag-box">‚öôÔ∏è Node.js</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="Future"><span class="tag-box">üöÄ –ë—É–¥—É—â–µ–µ & AI</span></label>
        </div>
        <button onclick="updateInterests()" id="interest-save-btn" class="btn-save-interests">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</button>
      </div>
    </div>

    <a href="/" style="display: block; margin-top: 35px; color: var(--primary); text-decoration: none; font-size: 14px; font-weight: 600;">‚Üê –ù–∞–∑–∞–¥ –≤ –ª–µ–Ω—Ç—É</a>
  </div>

  <div id="edit-mode" class="hidden">
    <h3>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</h3>
    <div class="upload-section">
      <input type="file" id="avatar-input" accept="image/*" onchange="initCropper(event)">
      <div id="cropper-container" class="hidden">
        <div style="max-height: 300px; overflow: hidden; border-radius: 12px; margin-top: 15px;">
          <img id="cropper-image" src="" style="max-width: 100%;">
        </div>
        <button type="button" onclick="applyCrop()" style="background:var(--primary); color:#fff; border:none; padding:12px 20px; border-radius:10px; margin-top:15px; cursor:pointer; font-weight: 600;">–û–±—Ä–µ–∑–∞—Ç—å</button>
      </div>
    </div>
    <div style="display: flex; gap: 12px;">
      <button onclick="saveAvatarOnly()" id="save-avatar-btn" style="background:#28a745; color:#fff; border:none; padding:15px 25px; border-radius:12px; cursor:pointer; flex:2; font-weight: bold;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
      <button onclick="toggleMode()" style="background:#eee; border:none; padding:15px 25px; border-radius:12px; cursor:pointer; flex:1;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script>
  let currentUser = JSON.parse(localStorage.getItem('user'));
  let cropper;
  let croppedBlob;

  function getYouTubeID(url) {
    if (!url) return null;
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  }

  function init() {
    if (!currentUser) { window.location.href = '/login.html'; return; }
    renderData();
    loadMyPosts();
  }

  function renderData() {
    const avatarCircle = document.getElementById('avatar-circle');
    const userInitial = currentUser.username ? currentUser.username[0].toUpperCase() : 'U';
    avatarCircle.innerHTML = currentUser.avatarUrl
            ? `<img src="${currentUser.avatarUrl}">`
            : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">${userInitial}</div>`;

    document.getElementById('display-name').innerText = currentUser.username;
    document.getElementById('display-email').innerText = currentUser.email;

    document.querySelectorAll('input[name="profile-interest"]').forEach(cb => {
      cb.checked = currentUser.interests && currentUser.interests.includes(cb.value);
    });
  }

  function switchTab(tab) {
    ['posts', 'bookmarks', 'liked', 'interests'].forEach(t => {
      document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
      document.getElementById(`content-${t}`).classList.toggle('hidden', t !== tab);
    });

    const userId = currentUser._id || currentUser.id;
    if(tab === 'posts') loadMyPosts();
    if(tab === 'bookmarks') loadBookmarks(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
    if(tab === 'liked') loadLikedPosts(userId);
  }

  async function loadMyPosts() {
    const list = document.getElementById('my-posts-list');
    const userId = currentUser._id || currentUser.id;
    list.innerHTML = "<p style='grid-column:1/-1; text-align:center;'>–ó–∞–≥—Ä—É–∑–∫–∞...</p>";
    try {
      const res = await fetch(`/api/content/my-posts/${userId}`);
      const posts = await res.json();
      document.getElementById('post-count').innerText = `(${posts.length})`;
      list.innerHTML = posts.length ? posts.map(p => renderPostCard(p, true)).join('') : "<p style='grid-column:1/-1; text-align:center;'>–ù–µ—Ç –ø–æ—Å—Ç–æ–≤</p>";
    } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"; }
  }

  async function loadBookmarks() {
    const list = document.getElementById('bookmarks-list');
    const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');

    if (bookmarks.length === 0) {
      list.innerHTML = "<p style='grid-column:1/-1; text-align:center; color:#86868b; padding:40px;'>–ù–µ—Ç –∑–∞–∫–ª–∞–¥–æ–∫ üìë</p>";
      return;
    }

    list.innerHTML = "<p style='grid-column:1/-1; text-align:center;'>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–ª–∞–¥–æ–∫...</p>";

    try {
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É ID –∏–∑ –∑–∞–∫–ª–∞–¥–æ–∫
      const promises = bookmarks.map(id => fetch(`/api/content/single/${id}`).then(r => r.ok ? r.json() : null));
      const results = await Promise.all(promises);
      const posts = results.filter(p => p !== null);

      list.innerHTML = posts.length
              ? posts.map(p => renderPostCard(p, false)).join('')
              : "<p style='grid-column:1/-1; text-align:center; color:#86868b; padding:40px;'>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–ª–∞–¥–æ–∫</p>";
    } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–ª–∞–¥–æ–∫"; }
  }

  async function loadLikedPosts(userId) {
    const list = document.getElementById('liked-posts-list');
    list.innerHTML = "<p style='grid-column:1/-1; text-align:center;'>–ó–∞–≥—Ä—É–∑–∫–∞...</p>";
    try {
      const res = await fetch(`/api/content/liked/${userId}`);
      const liked = await res.json();
      list.innerHTML = liked.length ? liked.map(p => renderPostCard(p, false)).join('') : "<p style='grid-column:1/-1; text-align:center;'>–ù–µ—Ç –ª–∞–π–∫–æ–≤ ‚ù§Ô∏è</p>";
    } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∞–π–∫–æ–≤"; }
  }

  async function deletePost(postId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏—é –Ω–∞–≤—Å–µ–≥–¥–∞? üóëÔ∏è')) return;
    try {
      const res = await fetch(`/api/content/${postId}`, { method: 'DELETE' });
      if (res.ok) {
        loadMyPosts();
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
      }
    } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
  }

  function renderPostCard(post, isOwnPost) {
    const ytId = getYouTubeID(post.mediaUrl) || getYouTubeID(post.body);
    const thumb = post.mediaUrl && post.type !== 'video' && !ytId
            ? post.mediaUrl
            : (ytId ? `https://img.youtube.com/vi/${ytId}/mqdefault.jpg` : '');

    return `
      <div class="post-item" id="post-${post._id}">
        <div class="post-preview" onclick="location.href='/post.html?id=${post._id}'">
          ${thumb ? `<img src="${thumb}">` : `<div style="padding:20px; color:white; font-size:12px; display:flex; align-items:center; height:100%; text-align:center; background:#1d1d1f;">${post.title}</div>`}
        </div>
        <div class="post-content">
          <div class="post-title" onclick="location.href='/post.html?id=${post._id}'">${post.title}</div>
          <div class="post-actions">
             <div style="font-size:13px; color:#86868b;">‚ù§Ô∏è ${post.likes || 0}  üí¨ ${post.stats?.commentsCount || 0}</div>
             ${isOwnPost ? `<button class="btn-delete-post" onclick="deletePost('${post._id}')">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
          </div>
        </div>
      </div>
    `;
  }

  async function updateInterests() {
    const btn = document.getElementById('interest-save-btn');
    const selected = Array.from(document.querySelectorAll('input[name="profile-interest"]:checked')).map(cb => cb.value);
    const userId = currentUser._id || currentUser.id;
    btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
    try {
      const res = await fetch('/api/users/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: userId, interests: selected })
      });
      if(res.ok) {
        const data = await res.json();
        localStorage.setItem('user', JSON.stringify(data.user));
        alert("–ò–Ω—Ç–µ—Ä–µ—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã! ‚ú®");
        location.reload();
      }
    } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); }
    btn.innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è";
  }

  function toggleMode() {
    document.getElementById('view-mode').classList.toggle('hidden');
    document.getElementById('edit-mode').classList.toggle('hidden');
  }

  function initCropper(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      document.getElementById('cropper-image').src = e.target.result;
      document.getElementById('cropper-container').classList.remove('hidden');
      if (cropper) cropper.destroy();
      cropper = new Cropper(document.getElementById('cropper-image'), { aspectRatio: 1, viewMode: 1 });
    };
    reader.readAsDataURL(file);
  }

  function applyCrop() {
    if (!cropper) return;
    cropper.getCroppedCanvas({ width: 400, height: 400 }).toBlob(blob => {
      croppedBlob = blob;
      alert("–§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é!");
    }, 'image/jpeg');
  }

  async function saveAvatarOnly() {
    if(!croppedBlob) return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏ –æ–±—Ä–µ–∂—å—Ç–µ —Ñ–æ—Ç–æ");
    const fd = new FormData();
    fd.append('avatar', croppedBlob);
    const userId = currentUser._id || currentUser.id;
    const btn = document.getElementById('save-avatar-btn');
    btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    try {
      const res = await fetch('/api/users/upload-avatar', {
        method: 'POST',
        headers: { 'x-author-id': userId },
        body: fd
      });
      if(res.ok) {
        const data = await res.json();
        localStorage.setItem('user', JSON.stringify(data.user));
        location.reload();
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ");
        btn.innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä";
      }
    } catch (e) {
      alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
      btn.innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä";
    }
  }

  init();
</script>
</body>
</html>