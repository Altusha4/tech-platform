<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å | TechPlatform</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <style>
    :root { --primary: #0071e3; --bg: #f5f5f7; --red: #ff3b30; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
    .profile-card { background: white; max-width: 850px; margin: 20px auto; padding: 35px; border-radius: 28px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }

    /* –®–∞–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è */
    .profile-header { display: flex; align-items: center; gap: 25px; margin-bottom: 35px; }
    .avatar { width: 110px; height: 110px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 45px; overflow: hidden; border: 4px solid #fff; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }

    /* –í–∫–ª–∞–¥–∫–∏ */
    .tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 30px; gap: 30px; }
    .tab-btn { padding: 12px 0; border: none; background: none; cursor: pointer; font-size: 16px; color: #888; border-bottom: 3px solid transparent; transition: 0.3s; }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }

    /* –°–µ—Ç–∫–∞ –ø–æ—Å—Ç–æ–≤ */
    .posts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
    .post-item { background: #fff; border: 1px solid #f0f0f0; border-radius: 18px; overflow: hidden; transition: 0.3s; }
    .post-item:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
    .post-preview { width: 100%; height: 150px; background: #1a1a1a; overflow: hidden; position: relative; }
    .post-preview img, .post-preview video { width: 100%; height: 100%; object-fit: cover; }
    .post-content { padding: 18px; }
    .post-title { font-size: 15px; font-weight: 600; margin: 0 0 12px 0; height: 42px; overflow: hidden; line-height: 1.4; }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .post-stats { display: flex; gap: 12px; font-size: 13px; color: #999; margin-bottom: 15px; }
    .post-actions { display: flex; gap: 10px; }
    .btn-action { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #eee; cursor: pointer; font-size: 13px; background: #fff; transition: 0.2s; }
    .btn-delete:hover { background: var(--red); color: white; border-color: var(--red); }
    .btn-edit-post:hover { background: var(--primary); color: white; border-color: var(--primary); }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —Ö—ç—à—Ç–µ–≥–æ–≤ */
    .interests-container { background: #f9f9fb; padding: 30px; border-radius: 20px; border: 1px solid #f0f0f5; }
    .interests-grid { display: flex; flex-wrap: wrap; gap: 12px; margin: 25px 0; }
    .interest-item { cursor: pointer; }
    .interest-item input { display: none; }
    .interest-item .tag-box {
      display: inline-block; padding: 10px 22px; border-radius: 25px;
      background: #fff; border: 2px solid #eee; color: #666; font-weight: 500; transition: 0.2s; user-select: none;
    }
    .interest-item input:checked + .tag-box {
      background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05);
    }

    .btn-save-interests { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 14px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }

    /* –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
    .hidden { display: none; }
    .upload-section { margin-bottom: 25px; padding: 20px; border: 2px dashed #eee; border-radius: 15px; text-align: center; }
    #cropper-container { margin-top: 20px; }
    .cropper-wrapper { max-height: 350px; border-radius: 12px; overflow: hidden; }
  </style>
</head>
<body>

<div class="profile-card">
  <div id="view-mode">
    <div class="profile-header">
      <div class="avatar" id="avatar-circle">?</div>
      <div>
        <h2 id="display-name" style="margin: 0; font-size: 26px;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <p id="display-email" style="color: #666; margin: 5px 0 0 0;"></p>
      </div>
      <button onclick="toggleMode()" style="margin-left: auto; background: #f0f0f2; border: none; padding: 12px 18px; border-radius: 12px; cursor: pointer; font-weight: 500;">‚öôÔ∏è –°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
    </div>

    <div class="tabs">
      <button class="tab-btn active" id="tab-posts" onclick="switchTab('posts')">–ú–æ–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ <span id="post-count"></span></button>
      <button class="tab-btn" id="tab-interests" onclick="switchTab('interests')">–ò–Ω—Ç–µ—Ä–µ—Å—ã</button>
    </div>

    <div id="content-posts">
      <div id="my-posts-list" class="posts-grid"></div>
    </div>

    <div id="content-interests" class="hidden">
      <div class="interests-container">
        <h3 style="margin-top:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–µ–Ω—Ç—ã üéØ</h3>
        <p style="color:#666; font-size:14px">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.</p>

        <div class="interests-grid">
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="ai"><span class="tag-box">#AI</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="javascript"><span class="tag-box">#JavaScript</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="mongodb"><span class="tag-box">#MongoDB</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="node"><span class="tag-box">#Node.js</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="apple"><span class="tag-box">#Apple</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="design"><span class="tag-box">#Design</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="backend"><span class="tag-box">#Backend</span></label>
          <label class="interest-item"><input type="checkbox" name="profile-interest" value="gadgets"><span class="tag-box">#Gadgets</span></label>
        </div>

        <button onclick="updateInterests()" id="interest-save-btn" class="btn-save-interests">–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—ã</button>
      </div>
    </div>

    <a href="/" style="display: block; margin-top: 35px; color: var(--primary); text-decoration: none; font-size: 15px; font-weight: 500;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
  </div>

  <div id="edit-mode" class="hidden">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h3>
    <div class="upload-section">
      <p style="margin-bottom: 15px; color: #666;">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</p>
      <input type="file" id="avatar-input" accept="image/*" onchange="initCropper(event)">

      <div id="cropper-container" class="hidden">
        <div class="cropper-wrapper"><img id="cropper-image" src=""></div>
        <button type="button" onclick="applyCrop()" style="background:var(--primary); color:#fff; border:none; padding:12px 20px; border-radius:10px; margin-top:15px; cursor:pointer; font-weight: 600;">–û–±—Ä–µ–∑–∞—Ç—å —Ñ–æ—Ç–æ</button>
      </div>
    </div>

    <div style="display: flex; gap: 12px;">
      <button onclick="saveAvatarOnly()" id="save-avatar-btn" style="background:#28a745; color:#fff; border:none; padding:15px 25px; border-radius:12px; cursor:pointer; flex:2; font-weight: bold;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
      <button onclick="toggleMode()" style="background:#eee; border:none; padding:15px 25px; border-radius:12px; cursor:pointer; flex:1;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script>
  let currentUser = JSON.parse(localStorage.getItem('user'));
  let cropper;
  let croppedBlob;

  function init() {
    if (!currentUser) { window.location.href = '/login.html'; return; }
    renderData();
    loadMyPosts();
  }

  function renderData() {
    const avatarCircle = document.getElementById('avatar-circle');
    avatarCircle.innerHTML = currentUser.avatarUrl
            ? `<img src="${currentUser.avatarUrl}">`
            : currentUser.username[0].toUpperCase();

    document.getElementById('display-name').innerText = currentUser.username;
    document.getElementById('display-email').innerText = currentUser.email;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ —Ö—ç—à—Ç–µ–≥–æ–≤
    document.querySelectorAll('input[name="profile-interest"]').forEach(cb => {
      cb.checked = currentUser.interests?.includes(cb.value);
    });
  }

  // --- –õ–û–ì–ò–ö–ê –í–ö–õ–ê–î–û–ö ---
  function switchTab(tab) {
    document.getElementById('tab-posts').classList.toggle('active', tab === 'posts');
    document.getElementById('tab-interests').classList.toggle('active', tab === 'interests');
    document.getElementById('content-posts').classList.toggle('hidden', tab !== 'posts');
    document.getElementById('content-interests').classList.toggle('hidden', tab !== 'interests');
    if(tab === 'posts') loadMyPosts();
  }

  // --- –ó–ê–ì–†–£–ó–ö–ê –ü–£–ë–õ–ò–ö–ê–¶–ò–ô ---
  async function loadMyPosts() {
    const list = document.getElementById('my-posts-list');
    const countSpan = document.getElementById('post-count');
    list.innerHTML = "<div style='grid-column: 1/-1; text-align:center;'>–ó–∞–≥—Ä—É–∑–∫–∞...</div>";

    try {
      const userId = currentUser.id || currentUser._id;
      const res = await fetch(`/api/content/user/${userId}`);
      const posts = await res.json();

      countSpan.innerText = posts.length > 0 ? `(${posts.length})` : '';

      if (posts.length === 0) {
        list.innerHTML = "<p style='color:#999; grid-column: 1/-1; text-align:center; padding: 40px;'>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π.</p>";
        return;
      }

      list.innerHTML = posts.map(post => `
        <div class="post-item" id="post-${post._id}">
          <div class="post-preview">
            ${post.mediaUrl
              ? (post.type === 'video' ? `<video src="${post.mediaUrl}"></video>` : `<img src="${post.mediaUrl}">`)
              : `<div style="padding:20px; color:#fff; font-size:12px; text-align:center; height:100%; display:flex; align-items:center;">${post.title}</div>`
      }
          </div>
          <div class="post-content">
            <div class="post-title">${post.title}</div>
            <div class="post-stats">
              <span>‚ù§Ô∏è ${post.likes || 0}</span>
              <span>üí¨ ${post.stats?.commentsCount || 0}</span>
            </div>
            <div class="post-actions">
              <button class="btn-action btn-edit-post" onclick="editPost('${post._id}')">‚öôÔ∏è</button>
              <button class="btn-action btn-delete" onclick="deletePost('${post._id}')">üóëÔ∏è</button>
            </div>
          </div>
        </div>
      `).join('');
    } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º"; }
  }

  // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–ï–°–û–í (#–•–≠–®–¢–ï–ì–ò) ---
  async function updateInterests() {
    const btn = document.getElementById('interest-save-btn');
    const selected = Array.from(document.querySelectorAll('input[name="profile-interest"]:checked')).map(cb => cb.value);
    const userId = currentUser.id || currentUser._id;

    btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
    btn.disabled = true;

    try {
      const res = await fetch('/api/users/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, interests: selected })
      });

      if(res.ok) {
        const data = await res.json();
        const updatedUser = { ...data.user, id: userId };
        localStorage.setItem('user', JSON.stringify(updatedUser));
        currentUser = updatedUser;
        alert("–ò–Ω—Ç–µ—Ä–µ—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã! –õ–µ–Ω—Ç–∞ –±—É–¥–µ—Ç –ø–æ–¥—Å—Ç—Ä–æ–µ–Ω–∞ –ø–æ–¥ –≤–∞—Å.");
      }
    } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); }
    finally { btn.innerText = "–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—ã"; btn.disabled = false; }
  }

  // --- –£–î–ê–õ–ï–ù–ò–ï ---
  async function deletePost(postId) {
    if(!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏—é?")) return;
    try {
      const res = await fetch(`/api/content/${postId}`, { method: 'DELETE' });
      if(res.ok) {
        document.getElementById(`post-${postId}`).style.opacity = '0';
        setTimeout(() => loadMyPosts(), 300);
      }
    } catch (e) { alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç"); }
  }

  function editPost(id) { alert("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ üõ†Ô∏è"); }

  // --- –†–ê–ë–û–¢–ê –° –ê–í–ê–¢–ê–†–û–ú (CROPPER) ---
  function toggleMode() {
    document.getElementById('view-mode').classList.toggle('hidden');
    document.getElementById('edit-mode').classList.toggle('hidden');
    if (cropper) cropper.destroy();
  }

  function initCropper(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = document.getElementById('cropper-image');
      img.src = e.target.result;
      document.getElementById('cropper-container').classList.remove('hidden');
      if (cropper) cropper.destroy();
      cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 });
    };
    reader.readAsDataURL(file);
  }

  function applyCrop() {
    cropper.getCroppedCanvas({ width: 400, height: 400 }).toBlob(blob => {
      croppedBlob = blob;
      alert("–§–æ—Ç–æ –æ–±—Ä–µ–∑–∞–Ω–æ!");
      document.getElementById('cropper-container').classList.add('hidden');
    }, 'image/jpeg');
  }

  async function saveAvatarOnly() {
    if(!croppedBlob) { alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ –∏ –Ω–∞–∂–º–∏—Ç–µ '–û–±—Ä–µ–∑–∞—Ç—å'"); return; }
    const userId = currentUser.id || currentUser._id;
    const btn = document.getElementById('save-avatar-btn');
    btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";

    const fd = new FormData();
    fd.append('avatar', croppedBlob);
    fd.append('userId', userId);

    try {
      const res = await fetch('/api/users/upload-avatar', { method: 'POST', body: fd });
      if(res.ok) {
        const data = await res.json();
        currentUser.avatarUrl = data.user.avatarUrl;
        localStorage.setItem('user', JSON.stringify(currentUser));
        location.reload();
      }
    } catch (e) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"); btn.innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ"; }
  }

  init();
</script>
</body>
</html>