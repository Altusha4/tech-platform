<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | TechPlatform</title>
  <style>
    :root { --primary: #0071e3; --bg: #f5f5f7; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1d1d1f; }

    .notif-container { max-width: 600px; margin: 40px auto; background: white; padding: 30px; border-radius: 28px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); }
    h1 { font-size: 28px; letter-spacing: -0.5px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }

    .notif-list { display: flex; flex-direction: column; gap: 12px; }
    .notif-item {
      display: flex; align-items: center; gap: 15px; padding: 15px;
      border-radius: 18px; background: #fff; border: 1px solid #f0f0f2;
      transition: 0.2s; cursor: pointer; text-decoration: none; color: inherit;
    }
    .notif-item:hover { background: #f9f9fb; transform: translateX(5px); }
    .notif-item.unread { border-left: 4px solid var(--primary); background: #f0f7ff; }

    .notif-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #eee; border: 1px solid #eee; }
    .notif-content { flex-grow: 1; font-size: 14px; }
    .notif-content b { color: #000; }
    .notif-time { font-size: 11px; color: #86868b; margin-top: 4px; }

    .empty-state { text-align: center; padding: 50px 0; color: #86868b; font-size: 16px; }
    .back-link { text-decoration: none; color: var(--primary); font-weight: 600; font-size: 14px; display: inline-block; margin-bottom: 10px; }
    .error-msg { text-align: center; color: #ff3b30; padding: 20px; font-size: 14px; line-height: 1.5; }
  </style>
</head>
<body>

<div class="notif-container">
  <a href="/" class="back-link">‚Üê –í –ª–µ–Ω—Ç—É</a>
  <h1>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è <span id="unread-dot" style="display:none; width:10px; height:10px; background:var(--primary); border-radius:50%;"></span></h1>

  <div id="notif-list" class="notif-list">
    <p style="text-align: center; color: #888;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–Ω–æ–≤–∞—Ü–∏–π...</p>
  </div>
</div>

<script>
  async function loadNotifications() {
    const list = document.getElementById('notif-list');

    // 1. –ü–†–û–í–ï–†–ö–ê –õ–û–ö–ê–õ–¨–ù–´–• –î–ê–ù–ù–´–•
    const userData = localStorage.getItem('user');
    if (!userData) {
      list.innerHTML = `<div class="empty-state">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è üîê</div>`;
      return;
    }

    const user = JSON.parse(userData);
    const userId = user?.id || user?._id;

    if (!userId || userId === "undefined") {
      list.innerHTML = `<div class="error-msg">‚ö†Ô∏è –û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç.</div>`;
      return;
    }

    try {
      // 2. –ó–ê–ü–†–û–° –ö –°–ï–†–í–ï–†–£
      const res = await fetch(`/api/notifications/${userId}`);

      if (!res.ok) {
        const errorData = await res.json().catch(() => ({}));
        throw new Error(errorData.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${res.status})`);
      }

      const data = await res.json();

      // 3. –û–ë–†–ê–ë–û–¢–ö–ê –ü–£–°–¢–û–ì–û –°–ü–ò–°–ö–ê
      if (!data || data.length === 0) {
        list.innerHTML = `<div class="empty-state">–ü–æ–∫–∞ –∑–¥–µ—Å—å —Ç–∏—à–∏–Ω–∞... ü§´</div>`;
        return;
      }

      // 4. –û–¢–†–ò–°–û–í–ö–ê
      list.innerHTML = data.map(n => {
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ —é–∑–µ—Ä —É–¥–∞–ª–µ–Ω)
        const sender = n.fromUserId || { username: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', avatarUrl: '' };
        const actionText = n.type === 'like' ? '–ø–æ—Å—Ç–∞–≤–∏–ª(–∞) ‚ù§Ô∏è –≤–∞—à–µ–º—É –ø–æ—Å—Ç—É' : '–ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª(–∞) –≤–∞—à –ø–æ—Å—Ç üí¨';

        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –∫ –∞–≤–∞—Ç–∞—Ä—É
        const avatar = sender.avatarUrl || `https://api.dicebear.com/7.x/big-ears/svg?seed=${sender.username}`;

        // –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ—Å—Ç
        const postLink = n.contentId ? `/post.html?id=${n.contentId}` : '#';

        return `
          <a href="${postLink}" class="notif-item">
            <img src="${avatar}" class="notif-avatar" onerror="this.src='https://api.dicebear.com/7.x/big-ears/svg?seed=fallback'">
            <div class="notif-content">
              <b>${sender.username}</b> ${actionText}
              <div class="notif-time">${new Date(n.createdAt).toLocaleString('ru-RU')}</div>
            </div>
          </a>
        `;
      }).join('');

    } catch (e) {
      console.error("Notification Load Error:", e);
      list.innerHTML = `
        <div class="error-msg">
          ‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π<br>
          <small>${e.message}</small><br>
          <button onclick="loadNotifications()" style="margin-top:10px; border:none; background:none; color:var(--primary); cursor:pointer; font-weight:600;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
        </div>`;
    }
  }

  loadNotifications();
</script>
</body>
</html>